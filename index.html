<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft File Manager - Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
  :root {
    --primary: #7f5af0;
    --primary-light: #9374f3;
    --background: #18181b;
    --surface: #232338;
    --surface-light: #2d2d45;
    --accent: #5ffbf1;
    --accent-dark: #4bd1c8;
    --danger: #ff5470;
    --danger-light: #ff7a90;
    --success: #36f09f;
    --warning: #E6C200;
    --text-primary: #f8fafc;
    --text-secondary: #d4d6e0;
    --text-muted: #9497a1;
    --border-radius: 12px;
    --shadow: 0 4px 20px rgba(0,0,0,0.2);
    --transition: all 0.3s ease;
    --home-opacity: 1;
    --thumbnail-opacity: 1;
    --global-opacity: 1;
    --font-size: 16px;
    font-family: 'Montserrat', system-ui, Segoe UI, Roboto, Arial;
    color: var(--text-primary);
  }

  /* Base styles */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  
  html {
    font-size: var(--font-size);
    scroll-behavior: smooth;
  }
  
  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background: linear-gradient(120deg, var(--surface) 0%, var(--primary) 100%);
    display: flex;
    flex-direction: column;
    min-width: 320px;
    line-height: 1.6;
    background-attachment: fixed;
    transition: background-position 0.1s ease;
    opacity: var(--global-opacity);
  }

  /* Custom background for premium users */
  body.custom-bg {
    background-image: var(--custom-bg-url);
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
  }

  body.custom-bg::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: -1;
  }
  
  img, video {
    max-width: 100%;
    height: auto;
  }
  
  /* Typography */
  h1, h2, h3, h4, h5, h6 {
    margin-top: 0;
    line-height: 1.3;
  }
  
  /* Header */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    background: var(--surface);
    color: #fff;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  header h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: bold;
  color: transparent;
  background: linear-gradient(120deg, var(--surface) 0%, var(--primary) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  text-shadow:
    2px 2px 0 var(--shadow-color, black),
    4px 4px 0 var(--shadow-color, black),
    6px 6px 0 var(--shadow-color, black);
}

  .header-buttons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .header-btn {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: var(--transition);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  .header-btn:hover {
    background: rgba(95, 251, 241, 0.15);
  }

  .premium-btn {
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    border: none;
    color: #000;
    font-weight: 700;
    animation: premiumPulse 2s infinite;
  }

  .premium-btn:hover {
    background: linear-gradient(90deg, #ffed4e, #ffd700);
    transform: scale(1.05);
  }

  @keyframes premiumPulse {
    0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
  }

  .premium-status {
    background: linear-gradient(90deg, #00ff88, #00cc6a);
    color: #000;
    font-weight: 700;
    cursor: default;
  }
  
  /* Main container */
  .container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    max-width: 800px;
    width: 90%;
    margin: 2rem auto;
    gap: 1.5rem;
  }

  /* Bento Grid for Large Screens */
  @media (min-width: 1200px) {
    .container {
      max-width: 1400px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: auto auto 1fr;
      grid-template-areas: 
        "notice notice notice"
        "categories files files"
        "categories files files";
      gap: 1.5rem;
    }

    .notice-box {
      grid-area: notice;
    }

    .categories-section {
      grid-area: categories;
    }

    .files-section {
      grid-area: files;
    }

    .files {
      max-height: none;
      height: 100%;
    }
  }
  
  /* Notice box */
  .notice-box {
    text-align: center;
    padding: 1.25rem;
    border: 2px dashed var(--primary);
    border-radius: var(--border-radius);
    background-color: rgba(255, 255, 255, 0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: var(--home-opacity);
  }

  .notice-box h2 {
    color: var(--warning);
    margin-top: 0;
    margin-bottom: 0.75rem;
  }
  
  .notice-box p {
    margin: 0.5rem 0;
  }
  
  .notice-box a {
    color: var(--success);
    font-weight: 600;
    text-decoration: none;
    transition: var(--transition);
  }
  
  .notice-box a:hover,
  .notice-box a:focus {
    text-decoration: underline;
    color: var(--accent);
  }

  /* Premium promotion banner */
  .premium-promo {
    background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700);
    color: #000;
    text-align: center;
    padding: 1rem;
    border-radius: var(--border-radius);
    margin: 1rem 0;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    animation: premiumBanner 3s infinite;
    opacity: var(--home-opacity);
  }

  .premium-promo:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  @keyframes premiumBanner {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  /* Search input */
  #searchInput {
    background-color: rgba(255, 255, 255, 0.9);
    padding: 0.75rem;
    width: 100%;
    border-radius: 8px;
    border: 2px solid var(--primary);
    margin-top: 1rem;
    font-family: inherit;
    font-size: 1rem;
    transition: var(--transition);
    opacity: var(--home-opacity);
  }
  
  #searchInput:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(95, 251, 241, 0.3);
  }
  
  /* Files container */
  .files {
    background: var(--surface);
    padding: 1.25rem;
    border-radius: var(--border-radius);
    min-height: 200px;
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 0;
    box-shadow: var(--shadow);
    opacity: var(--home-opacity);
  }
  
  /* File item */
  .file {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--surface-light);
    position: relative;
    gap: 0.75rem;
  }
  
  .file:last-child {
    border-bottom: none;
  }
  
  /* Thumbnail */
  .thumbnail {
    width: 200px;
    max-width: 90%;
    height: auto;
    border-radius: var(--border-radius);
    object-fit: cover;
    background: var(--surface);
    border: 4px solid var(--accent);
    transition: var(--transition);
    margin-bottom: 0.5rem;
  }
  
  .thumbnail:hover {
    transform: scale(1.03);
    border-color: var(--accent-dark);
  }
  
  /* File name */
  .name {
    font-weight: 700;
    color: var(--accent);
    word-break: break-word;
    text-align: center;
    font-size: 1.15rem;
  }
  
  /* Meta information */
  .meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 0.5rem;
    flex-wrap: wrap;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }
  
  /* Actions */
  .actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }
  
  /* Buttons */
  .btn {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    color: #fff;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    border: 0;
    cursor: pointer;
    font-weight: 600;
    font-family: inherit;
    font-size: 0.95rem;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
    max-width: 100%;
    word-wrap: break-word;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .btn:hover,
  .btn:focus {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn.danger {
    background: linear-gradient(90deg, var(--danger), var(--danger-light));
  }
  
  .btn.secondary {
    background: linear-gradient(90deg, var(--surface), var(--primary));
    border: 1px solid var(--accent);
  }

  .btn.save {
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    color: #000;
  }
  
  .btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  /* Premium Modal */
  .premium-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    padding: 1rem;
  }

  .premium-content {
    background: var(--surface);
    padding: 2rem;
    border-radius: var(--border-radius);
    color: var(--text-primary);
    max-width: 500px;
    width: 100%;
    box-shadow: var(--shadow);
    max-height: 90vh;
    overflow-y: auto;
  }

  .premium-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .premium-title {
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .premium-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  .premium-features {
    margin: 2rem 0;
  }

  .premium-features h3 {
    color: var(--accent);
    margin-bottom: 1rem;
  }

  .premium-features ul {
    list-style: none;
    padding: 0;
  }

  .premium-features li {
    display: flex;
    align-items: center;
    margin: 0.5rem 0;
    color: var(--text-secondary);
  }

  .premium-features li:before {
    content: "✨";
    margin-right: 0.5rem;
  }

  .payment-form {
    margin: 2rem 0;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .form-group input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--surface-light);
    border-radius: 8px;
    background: var(--background);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 1rem;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-row .form-group {
    flex: 1;
  }

  .checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin: 1.5rem 0;
  }

  .checkbox-group input[type="checkbox"] {
    margin-top: 0.2rem;
  }

  .checkbox-group label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.4;
  }

  .premium-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .premium-close {
    background: var(--danger);
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
  }

  .premium-close:hover {
    background: var(--danger-light);
  }

  .premium-purchase {
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    color: #000;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    font-size: 1.1rem;
    transition: var(--transition);
  }

  .premium-purchase:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .premium-purchase:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Bottom Navigation for Premium Users */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface);
    display: none;
    justify-content: center;
    padding: 1rem;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
    z-index: 100;
  }

  .bottom-nav.show {
    display: flex;
  }

  .nav-btn {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
    padding: 0.75rem 1.5rem;
    margin: 0 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-btn.active {
    background: var(--primary);
    color: #fff;
  }

  .nav-btn:hover {
    background: var(--primary);
    color: #fff;
  }

  /* Theme Section - NEW DESIGN */
  .theme-section {
    display: none;
  }

  .theme-section.active {
    display: block;
  }

  .theme-main-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
  }

  .theme-main-btn {
    background: var(--surface-light);
    border: 2px solid var(--primary);
    color: var(--text-primary);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: 600;
    transition: var(--transition);
    text-align: center;
  }

  .theme-main-btn:hover {
    background: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow);
  }

  .theme-subpage {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--surface);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    z-index: 10002;
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
  }

  .theme-subpage.active {
    display: block;
  }

  .theme-back-btn {
    background: var(--surface-light);
    border: 2px solid var(--primary);
    color: var(--text-primary);
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 1.5rem;
    transition: var(--transition);
  }

  .theme-back-btn:hover {
    background: var(--primary);
  }

  .theme-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
  }

  .theme-item {
    background: var(--surface-light);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    border: 3px solid transparent;
    transition: var(--transition);
    text-align: center;
  }

  .theme-item.selected {
    border-color: var(--accent);
  }

  .theme-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  .wallpaper-item {
    position: relative;
    cursor: pointer;
    border-radius: var(--border-radius);
    overflow: hidden;
    border: 3px solid transparent;
    transition: var(--transition);
  }

  .wallpaper-item.selected {
    border-color: var(--accent);
  }

  .wallpaper-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }

  .wallpaper-item:hover {
    transform: scale(1.05);
  }

  .upload-area {
    border: 2px dashed var(--primary);
    border-radius: var(--border-radius);
    padding: 2rem;
    text-align: center;
    margin: 1rem 0;
    cursor: pointer;
    transition: var(--transition);
  }

  .upload-area:hover {
    border-color: var(--accent);
    background: rgba(95, 251, 241, 0.05);
  }

  .upload-area input[type="file"] {
    display: none;
  }

  .upload-loading {
    display: none;
    align-items: center;
    justify-content: center;
    margin-top: 1rem;
  }

  .upload-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
    margin-right: 0.5rem;
  }

  .custom-items-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--surface-light);
    border-radius: var(--border-radius);
  }

  .custom-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }

  .custom-item {
    background: var(--surface);
    padding: 1rem;
    border-radius: var(--border-radius);
    text-align: center;
    position: relative;
  }

  .custom-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 0.5rem;
  }

  .custom-item-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 0.5rem;
  }

  .custom-item-btn {
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
  }

  .delete-btn {
    background: var(--danger);
    color: white;
  }

  .surprise-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
  }

  .surprise-checkbox {
    display: none;
  }

  .surprise-checkbox-label {
    background: var(--surface-light);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
  }

  .surprise-checkbox:checked + .surprise-checkbox-label {
    background: var(--primary);
    border-color: var(--accent);
  }

  /* Opacity Controls */
  .opacity-controls {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--surface-light);
    border-radius: var(--border-radius);
    text-align: center;
  }

  .opacity-control {
    margin: 1rem 0;
  }

  .opacity-control label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .opacity-control input[type="range"] {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--background);
    outline: none;
    -webkit-appearance: none;
  }

  .opacity-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .opacity-value {
    color: var(--accent);
    font-weight: 600;
    margin-left: 1rem;
  }

  .reset-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  /* Font Size Controls */
  .font-size-controls {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--surface-light);
    border-radius: var(--border-radius);
    text-align: center;
  }

  .font-size-control {
    margin: 1rem 0;
  }

  .font-size-control label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .font-size-control input[type="range"] {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--background);
    outline: none;
    -webkit-appearance: none;
  }

  .font-size-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .font-size-value {
    color: var(--accent);
    font-weight: 600;
    margin-left: 1rem;
  }

  /* Library Section */
  .library-section {
    display: none;
  }

  .library-section.active {
    display: block;
  }

  .library-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .library-tab {
    background: var(--surface-light);
    color: var(--text-secondary);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
  }

  .library-tab.active {
    background: var(--accent);
    color: #000;
  }

  .library-content {
    min-height: 300px;
  }

  .saved-item {
    background: var(--surface-light);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .history-item {
    background: var(--surface-light);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .history-timestamp {
    color: var(--text-muted);
    font-size: 0.8rem;
  }

  /* Loading and Download screens */
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(20, 20, 30, 0.9);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    backdrop-filter: blur(5px);
  }
  
  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1.5rem;
  }
  
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  
  #loadingText {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 500;
    text-align: center;
  }
  
  #downloadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(20, 20, 30, 0.95);
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
  }
  
  #downloadBar {
    width: 100%;
    max-width: 500px;
    background: var(--surface);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  #downloadFileName {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 1rem;
    word-break: break-word;
    text-align: center;
  }
  
  #progressBarContainer {
    width: 100%;
    background: var(--background);
    border-radius: 8px;
    margin: 1rem 0;
    height: 24px;
    overflow: hidden;
  }
  
  #progressBar {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    height: 100%;
    width: 0;
    transition: width 0.3s ease;
    border-radius: 8px;
  }
  
  #progressText {
    color: var(--accent);
    font-weight: 600;
    font-size: 1rem;
    text-align: center;
    white-space: pre-line;
    margin-bottom: 1rem;
  }
  
  #downloadCancelBtn {
    background: linear-gradient(90deg, var(--danger), var(--danger-light));
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: 0;
    cursor: pointer;
    font-weight: 600;
    font-family: inherit;
    transition: var(--transition);
  }
  
  #downloadCancelBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  /* Custom Dropdown Styles */
  .filters {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }

  .custom-dropdown {
    position: relative;
    display: inline-block;
    min-width: 160px;
    flex: 1;
    max-width: 100%;
  }

  .dropdown-button {
    width: 100%;
    padding: 0.6rem 2.2rem 0.6rem 1rem;
    border-radius: 8px;
    border: 2px solid var(--primary);
    background: linear-gradient(180deg, var(--surface) 0%, rgba(0,0,0,0.03) 100%);
    color: var(--text-primary);
    font-size: 0.95rem;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: inherit;
    font-weight: 400;
  }

  .dropdown-button:hover {
    border-color: var(--accent);
    background: linear-gradient(180deg, var(--surface-light) 0%, rgba(0,0,0,0.05) 100%);
  }

  .dropdown-button:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(95,251,241,0.06);
  }

  .dropdown-arrow {
    color: var(--text-secondary);
    font-size: 0.9rem;
    transition: transform 0.2s ease;
    pointer-events: none;
  }

  .dropdown-button.open .dropdown-arrow {
    transform: rotate(180deg);
  }

  .dropdown-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface);
    border: 2px solid var(--primary);
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    margin-top: 2px;
  }

  .dropdown-options.open {
    display: block;
  }

  .dropdown-option {
    padding: 0.6rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    color: var(--text-primary);
    border-bottom: 1px solid var(--surface-light);
  }

  .dropdown-option:last-child {
    border-bottom: none;
  }

  .dropdown-option:hover {
    background-color: var(--surface-light);
  }

  .dropdown-option.selected {
    background: var(--accent);
    color: #031018;
    font-weight: 600;
  }

  .dropdown-option.selected:hover {
    background: var(--accent-dark);
  }

  /* Hide ads for premium users */
  .premium-user .ads-footer-container,
  .premium-user #adsContainerBottom {
    display: none !important;
  }

  /* Footer styles */
  .footer-buttons-bottom {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 1rem 0 0.5rem;
    flex-wrap: wrap;
    opacity: var(--home-opacity);
  }
  
  .footer-btn {
    background: transparent;
    color: var(--warning);
    border: 1px solid var(--warning);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-family: inherit;
    transition: var(--transition);
    text-decoration: none;
  }
  
  .footer-btn:hover,
  .footer-btn:focus {
    background-color: rgba(230, 194, 0, 0.1);
    color: var(--accent);
    border-color: var(--accent);
  }

  .footer-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(22, 22, 32, 0.95);
    z-index: 9999999;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    animation: fadeInModal 0.3s ease;
    padding: 1.5rem;
  }
  
  @keyframes fadeInModal {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  .footer-modal-content {
    background: var(--surface);
    color: var(--text-primary);
    border-radius: var(--border-radius);
    max-width: 95vw;
    width: 500px;
    padding: 2rem;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    align-items: center;
    position: relative;
    text-align: left;
    font-size: 1rem;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .footer-section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 0.5rem;
    text-align: center;
  }
  
  .footer-section-content {
    color: var(--text-secondary);
    line-height: 1.6;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    word-break: break-word;
  }
  
  .footer-contact-link {
    color: var(--primary-light);
    text-decoration: underline;
    font-weight: 600;
    word-break: break-word;
    transition: var(--transition);
  }
  
  .footer-contact-link:hover,
  .footer-contact-link:focus {
    color: var(--accent);
  }
  
  .footer-modal-back {
    background: linear-gradient(90deg, var(--danger), var(--danger-light));
    color: #fff;
    border: none;
    border-radius: 7px;
    font-weight: 600;
    padding: 0.6rem 1.25rem;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: var(--transition);
  }
  
  .footer-modal-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* Ads containers - hidden for premium users */
  .ads-footer-container {
    width: 100%;
    background: var(--surface);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin: 2rem 0 1rem;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 120px;
    position: relative;
  }
  
  .ads-footer-container::before {
    content: "Advertisement";
    position: absolute;
    top: 0.5rem;
    left: 1rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .ads-footer-content {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    margin-top: 1rem;
  }
  
  .ads-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 0.9rem;
    border: 1px dashed var(--surface-light);
    border-radius: var(--border-radius);
    padding: 2rem;
    background: rgba(255, 255, 255, 0.02);
    width: 100%;
    max-width: 728px;
    min-height: 90px;
  }

  #adsContainerBottom {
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: var(--surface);
    border-radius: var(--border-radius);
    margin: 1rem 0;
    width: 100%;
    position: static;
    min-height: 90px;
    box-shadow: none;
    margin-top: 2rem;
  }

  /* Status messages */
  .status-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
  }
  
  .status-error {
    color: var(--danger);
  }
  
  .status-success {
    color: var(--success);
  }

  /* Help modal */
  .help-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .help-content {
    background: var(--surface);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    color: var(--text-primary);
    max-width: 400px;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .help-content h2 {
    color: var(--accent);
    margin-bottom: 1rem;
  }

  .help-content button {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    border: none;
    background: var(--primary);
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
  }

  .help-content button:hover {
    background: var(--accent-dark);
  }

  /* Premium verification elements (invisible) */
  .premium-verification {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Timed buttons */
  .timed-button {
    position: fixed;
    top: 100px;
    left: 20px;
    background: var(--danger);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    z-index: 1000;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: var(--transition);
    animation: fadeInOut 15s ease-in-out;
    display: none;
  }

  .timed-button:hover {
    background: var(--danger-light);
    transform: translateY(-2px);
  }

  @keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translateY(-10px); }
    10%, 90% { opacity: 1; transform: translateY(0); }
  }

  /* Reset button */
  .reset-btn {
    background: var(--warning);
    color: #000;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 0.5rem;
    transition: var(--transition);
  }

  .reset-btn:hover {
    background: #ffed4e;
  }

  /* Accessibility improvements */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  /* Focus styles for accessibility */
  button:focus-visible,
  a:focus-visible,
  input:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Reduced motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* Skeleton Loading */
  .skeleton {
    background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
  }

  .skeleton-thumbnail {
    width: 200px;
    height: 120px;
    margin: 0 auto;
  }

  .skeleton-name {
    width: 80%;
    height: 1.5rem;
    margin: 0.5rem auto;
  }

  .skeleton-meta {
    width: 60%;
    height: 1rem;
    margin: 0.5rem auto;
  }

  .skeleton-actions {
    width: 100%;
    height: 2.5rem;
    margin: 0.5rem auto;
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  /* Categories Section */
  .categories-section {
    margin-bottom: 1.5rem;
    opacity: var(--home-opacity);
  }

  .categories-carousel {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding: 0.5rem;
    margin: 1rem 0;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--surface);
  }

  .categories-carousel::-webkit-scrollbar {
    height: 6px;
  }

  .categories-carousel::-webkit-scrollbar-track {
    background: var(--surface);
    border-radius: 3px;
  }

  .categories-carousel::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
  }

  .category-chip {
    background: var(--surface-light);
    color: var(--text-secondary);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .category-chip.active {
    background: var(--primary);
    color: white;
  }

  .category-chip:hover {
    background: var(--primary-light);
    color: white;
  }

  /* Accordion Styles */
  .accordion {
    width: 100%;
    margin: 1rem 0;
  }

  .accordion-item {
    background: var(--surface-light);
    border-radius: var(--border-radius);
    margin-bottom: 0.5rem;
    overflow: hidden;
  }

  .accordion-header {
    background: var(--surface);
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    transition: var(--transition);
  }

  .accordion-header:hover {
    background: var(--primary);
  }

  .accordion-header.active {
    background: var(--primary);
  }

  .accordion-content {
    padding: 0 1.5rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }

  .accordion-content.active {
    padding: 1rem 1.5rem;
    max-height: 500px;
  }

  .accordion-icon {
    transition: transform 0.3s ease;
  }

  .accordion-header.active .accordion-icon {
    transform: rotate(180deg);
  }

  /* Performance optimizations */
  .will-change {
    will-change: transform, opacity;
  }

  /* Hardware acceleration */
  .hardware-accelerate {
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000px;
  }

  /* Global Opacity Styles */
  .global-opacity-target {
    opacity: var(--global-opacity, 1);
  }

  .global-opacity-target * {
    opacity: 1 !important;
  }

  /* Website Outline Styles */
  .outline-element {
    outline: 2px solid var(--primary);
    outline-offset: -1px;
  }

  /* Games Section */
  .games-section {
    margin-top: 2rem;
  }

  .games-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }

  .game-item {
    background: var(--surface-light);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
  }

  .game-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  /* Whole Website Skeleton */
  .website-skeleton {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--background);
    z-index: 99999;
    display: flex;
    flex-direction: column;
  }

  .skeleton-header {
    background: var(--surface);
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .skeleton-title {
    width: 200px;
    height: 2rem;
    background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
  }

  .skeleton-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .skeleton-button {
    width: 80px;
    height: 2rem;
    background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 6px;
  }

  .skeleton-main {
    flex: 1;
    padding: 1.5rem;
    max-width: 800px;
    width: 90%;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .skeleton-notice {
    width: 100%;
    height: 120px;
    background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: var(--border-radius);
  }

  .skeleton-categories {
    width: 100%;
    height: 60px;
    background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: var(--border-radius);
  }

  .skeleton-files {
    flex: 1;
    background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: var(--border-radius);
  }

  /* File Details Modal */
  .file-details-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    padding: 1rem;
  }

  .file-details-content {
    background: var(--surface);
    padding: 2rem;
    border-radius: var(--border-radius);
    color: var(--text-primary);
    max-width: 600px;
    width: 100%;
    box-shadow: var(--shadow);
    max-height: 90vh;
    overflow-y: auto;
  }

  .file-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .file-details-thumbnail {
    width: 100%;
    max-width: 300px;
    height: auto;
    border-radius: var(--border-radius);
    margin: 0 auto 1.5rem;
    display: block;
  }

  .file-details-description {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .file-details-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .file-details-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--surface-light);
    border-radius: 6px;
    color: var(--text-primary);
    text-decoration: none;
    transition: var(--transition);
  }

  .file-details-link:hover {
    background: var(--primary);
    color: white;
  }

  .file-details-link-icon {
    width: 16px;
    height: 16px;
  }

  /* Section Transitions */
  .section-transition {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .section-transition.active {
    opacity: 1;
    transform: translateY(0);
  }

  /* File with thumbnail */
  .file-with-thumbnail {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--surface-light);
    position: relative;
  }

  .file-with-thumbnail:last-child {
    border-bottom: none;
  }

  .file-thumbnail-small {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius);
    object-fit: cover;
    background: var(--surface);
    border: 2px solid var(--accent);
    transition: var(--transition);
    flex-shrink: 0;
  }

  .file-thumbnail-small:hover {
    transform: scale(1.03);
    border-color: var(--accent-dark);
  }

  .file-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .file-expand-btn {
    background: transparent;
    border: none;
    color: var(--accent);
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    margin-top: 0.5rem;
    transition: var(--transition);
  }

  .file-expand-btn:hover {
    color: var(--accent-dark);
  }

  .file-description-preview {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.4;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .file-description-preview.expanded {
    max-height: 200px;
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    :root {
      font-size: 15px;
    }
    
    header {
      padding: 1rem;
    }
    
    header h1 {
      font-size: 1.75rem;
    }
    
    .container {
      padding: 1rem;
      width: 95%;
      margin: 1rem auto;
    }
    
    .files {
      padding: 1rem;
      max-height: 65vh;
    }
    
    .file {
      padding: 1rem 0;
    }
    
    .thumbnail {
      width: 180px;
    }
    
    .footer-modal-content {
      padding: 1.5rem 1rem;
    }
    
    .footer-buttons-bottom {
      gap: 0.75rem;
    }
    
    .btn {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
    }

    .bottom-nav {
      padding: 0.75rem;
    }

    .nav-btn {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
    }

    .wallpaper-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }

    .theme-grid {
      grid-template-columns: 1fr;
    }

    .library-tabs {
      justify-content: center;
    }

    .premium-content {
      padding: 1.5rem;
    }

    .form-row {
      flex-direction: column;
      gap: 0;
    }

    .theme-dropdowns {
      flex-direction: column;
    }

    .theme-dropdown {
      min-width: 100%;
    }

    .timed-button {
      top: 80px;
      left: 10px;
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .categories-carousel {
      padding: 0.25rem;
    }

    .category-chip {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    .theme-main-buttons {
      gap: 0.75rem;
    }

    .theme-main-btn {
      padding: 1.25rem;
      font-size: 1.1rem;
    }
  }
  
  @media (max-width: 480px) {
    :root {
      font-size: 14px;
    }
    
    header h1 {
      font-size: 1.5rem;
    }
    
    .notice-box {
      padding: 1rem;
    }
    
    .thumbnail {
      width: 160px;
    }
    
    .footer-modal-content {
      width: 95%;
      padding: 1.25rem 0.75rem;
    }
    
    .footer-buttons-bottom {
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    
    .footer-btn {
      width: 100%;
      text-align: center;
    }

    .header-buttons {
      gap: 0.3rem;
    }

    .header-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }

    .bottom-nav {
      flex-direction: row;
      overflow-x: auto;
    }

    .nav-btn {
      flex-shrink: 0;
      padding: 0.5rem 0.8rem;
      margin: 0 0.25rem;
    }

    .wallpaper-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }

    .custom-dropdown {
      min-width: unset;
      width: 100%;
    }
    
    .dropdown-button {
      padding: 0.6rem 1.8rem 0.6rem 0.8rem;
      font-size: 0.9rem;
    }

    .timed-button {
      top: 70px;
      left: 5px;
      font-size: 0.7rem;
      padding: 0.3rem 0.6rem;
    }

    .category-chip {
      padding: 0.3rem 0.6rem;
      font-size: 0.7rem;
    }

    .theme-grid {
      grid-template-columns: 1fr;
    }

    .theme-main-buttons {
      gap: 0.5rem;
    }

    .theme-main-btn {
      padding: 1rem;
      font-size: 1rem;
    }
.file-with-thumbnail {
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.file-thumbnail-small {
  width: 160px;
  height: auto;
  margin-bottom: 0.5rem;
}

.file-content {
  align-items: center;
}
.mpack-title {
  font-size: 2.3rem;
  font-weight: 900;
  color: inherit;
  text-shadow:
    2px 2px 0 black,
    4px 4px 0 black,
    6px 6px 0 black;
  letter-spacing: 1px;
}

body {
  --dynamic-bg: var(--primary);
}
  }
  </style>
</head>
<body>
  <!-- Whole Website Skeleton -->
  <div id="websiteSkeleton" class="website-skeleton">
    <div class="skeleton-header">
      <div class="skeleton-title"></div>
      <div class="skeleton-buttons">
        <div class="skeleton-button"></div>
        <div class="skeleton-button"></div>
        <div class="skeleton-button"></div>
      </div>
    </div>
    <div class="skeleton-main">
      <div class="skeleton-notice"></div>
      <div class="skeleton-categories"></div>
      <div class="skeleton-files"></div>
    </div>
  </div>

  <!-- Premium Verification Elements (Invisible) -->
  <div id="premiumVerification1" class="premium-verification"></div>
  <div id="premiumVerification2" class="premium-verification"></div>
  <div id="premiumVerification3" class="premium-verification"></div>

  <!-- Timed buttons -->
  <button id="timedResetBtn" class="timed-button">Reset Theme</button>
  <button id="timedContactBtn" class="timed-button">Contact Support</button>

  <header role="banner">
    <h1 class="mpack-title">M-PACK</h1>
    <div class="header-buttons">
      <button id="helpBtn" class="header-btn">❓ Help</button>
      <button id="refreshBtn" class="header-btn">🔄 Refresh</button>
      <button id="premiumBtn" class="header-btn premium-btn">✨ Get Premium</button>
    </div>
  </header>

  <main class="container" role="main">
    <!-- Premium Promotion Banner (shown randomly) -->
    <div id="premiumPromo" class="premium-promo global-opacity-target" style="display: none;">
      ✨ Upgrade to Premium for Ad-Free Experience, Custom Themes & More! Click here! ✨
    </div>

    <!-- Home Section -->
    <section id="homeSection" class="home-section section-transition active">
      <div class="notice-box global-opacity-target" aria-labelledby="important-notice">
        <h2 id="important-notice">⚠️ Important Notice</h2>
        <p>Get our app: <a href="https://sifat8668.github.io/Mpacksapp/" target="_blank" rel="noopener">Mpacks app</a></p>
        <p>Files will download with correct extensions (.mcpack/.mcworld)</p>
        
        <label for="searchInput" class="sr-only">Search packs</label>
        <input type="text" id="searchInput" placeholder="Search packs..." aria-label="Search packs">

        <div class="filters">
          <div class="custom-dropdown">
            <button class="dropdown-button" id="fileTypeButton" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span class="dropdown-text">All Types</span>
              <span class="dropdown-arrow">▾</span>
            </button>
            <div class="dropdown-options" id="fileTypeOptions" role="listbox">
              <div class="dropdown-option selected" data-value="all" role="option">All Types</div>
              <div class="dropdown-option" data-value="mcpack" role="option">.mcpack</div>
              <div class="dropdown-option" data-value="mcworld" role="option">.mcworld</div>
            </div>
          </div>
          
          <div class="custom-dropdown">
            <button class="dropdown-button" id="sortByButton" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span class="dropdown-text">A—Z Name</span>
              <span class="dropdown-arrow">▾</span>
            </button>
            <div class="dropdown-options" id="sortByOptions" role="listbox">
              <div class="dropdown-option selected" data-value="az" role="option">A—Z Name</div>
              <div class="dropdown-option" data-value="za" role="option">Z—A Name</div>
              <div class="dropdown-option" data-value="largest" role="option">Largest First</div>
              <div class="dropdown-option" data-value="smallest" role="option">Smallest First</div>
            </div>
          </div>
          
          <!-- Premium Trend Filter -->
          <div class="custom-dropdown" id="trendFilterContainer" style="display: none;">
            <button class="dropdown-button" id="trendButton" type="button" aria-haspopup="listbox" aria-expanded="false">
              <span class="dropdown-text">Trending: All Time</span>
              <span class="dropdown-arrow">▾</span>
            </button>
            <div class="dropdown-options" id="trendOptions" role="listbox">
              <div class="dropdown-option selected" data-value="all" role="option">All Time</div>
              <div class="dropdown-option" data-value="today" role="option">Today</div>
              <div class="dropdown-option" data-value="week" role="option">This Week</div>
              <div class="dropdown-option" data-value="month" role="option">This Month</div>
              <div class="dropdown-option" data-value="year" role="option">This Year</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Categories Section -->
      <div class="categories-section global-opacity-target">
        <h3>Categories</h3>
        <div class="categories-carousel" id="categoriesCarousel">
          <!-- Categories will be dynamically added here -->
        </div>
      </div>
      
      <section class="files-section" aria-labelledby="files-heading">
        <h2 id="files-heading" class="sr-only">Available Minecraft Packs</h2>
        <div class="files global-opacity-target" id="fileList" role="list" aria-label="List of Minecraft packs"></div>
      </section>
    </section>

    <!-- Theme Section (Premium Only) - NEW DESIGN -->
    <section id="themeSection" class="theme-section section-transition">
      <div class="notice-box global-opacity-target">
        <h2>🎨 Theme Customization</h2>
        
        <!-- Main Theme Buttons -->
        <div class="theme-main-buttons">
          <button class="theme-main-btn" id="setWallpaperBtn">📷 Set Wallpaper</button>
          <button class="theme-main-btn" id="setThemeBtn">🎭 Set Theme</button>
          <button class="theme-main-btn" id="setSurprisesBtn">🎁 Set Surprises</button>
        </div>
        
        <!-- Opacity Controls -->
        <div class="opacity-controls">
          <h3>🌫️ Opacity Settings</h3>
          <div class="opacity-control">
            <label for="globalOpacity">Global Opacity (everything on the website):</label>
            <input type="range" id="globalOpacity" min="0" max="100" value="100">
            <span id="globalOpacityValue" class="opacity-value">100%</span>
          </div>
        </div>
        
        <!-- Font Size Controls -->
        <div class="font-size-controls">
          <h3>🔤 Font Size Settings</h3>
          <div class="font-size-control">
            <label for="globalFontSize">Global Font Size (everything on the website):</label>
            <input type="range" id="globalFontSize" min="12" max="24" value="16">
            <span id="globalFontSizeValue" class="font-size-value">16px</span>
          </div>
        </div>
        
        <!-- Reset Buttons -->
        <div class="reset-buttons">
          <button class="btn danger" id="resetWallpaperBtn">Reset Wallpaper</button>
          <button class="btn danger" id="resetThemeBtn">Reset Theme</button>
          <button class="btn danger" id="resetSurprisesBtn">Reset Surprises</button>
          <button class="btn danger" id="resetFontSizeBtn">Reset Font Size</button>
        </div>
      </div>
      
      <!-- Wallpaper Subpage -->
      <div id="wallpaperSubpage" class="theme-subpage">
        <button class="theme-back-btn" id="wallpaperBackBtn">← Back</button>
        <h2>📷 Set Wallpaper</h2>
        
        <div class="theme-main-buttons">
          <button class="theme-main-btn" id="githubWallpapersBtn">GitHub Wallpapers</button>
          <button class="theme-main-btn" id="uploadWallpaperBtn">Upload Custom Wallpaper</button>
          <button class="theme-main-btn" id="customWallpapersBtn">My Custom Wallpapers</button>
        </div>
        
        <!-- GitHub Wallpapers -->
        <div id="githubWallpapersSection" class="custom-items-section" style="display: none;">
          <h3>GitHub Wallpapers</h3>
          <div class="wallpaper-grid" id="githubWallpapersGrid">
            <!-- GitHub wallpapers will be dynamically added here -->
          </div>
          <button class="btn apply-btn" id="applyGithubWallpaper" style="margin-top: 1rem;">Apply Selected Wallpaper</button>
        </div>
        
        <!-- Upload Custom Wallpaper -->
        <div id="uploadWallpaperSection" class="custom-items-section" style="display: none;">
          <h3>Upload Custom Wallpaper</h3>
          <div class="upload-area" id="wallpaperUpload">
            <input type="file" id="wallpaperFile" accept="image/*">
            <p>📎 Click to upload custom wallpaper (PNG, JPG, GIF, etc.)</p>
          </div>
          <div class="upload-loading" id="wallpaperUploadLoading">
            <div class="upload-spinner"></div>
            <span>Uploading wallpaper...</span>
          </div>
          <button class="btn apply-btn" id="applyCustomWallpaper">Apply Custom Wallpaper</button>
        </div>
        
        <!-- Custom Wallpapers Management -->
        <div id="customWallpapersSection" class="custom-items-section" style="display: none;">
          <h3>📁 Your Custom Wallpapers</h3>
          <div class="custom-items-grid" id="customWallpapersGrid">
            <!-- Custom wallpapers will be dynamically added here -->
          </div>
        </div>
      </div>
      
      <!-- Theme Subpage -->
      <div id="themeSubpage" class="theme-subpage">
        <button class="theme-back-btn" id="themeBackBtn">← Back</button>
        <h2>🎭 Set Theme</h2>
        
        <div class="theme-main-buttons">
          <button class="theme-main-btn" id="githubThemesBtn">GitHub Themes</button>
          <button class="theme-main-btn" id="uploadThemeBtn">Upload Custom Theme</button>
          <button class="theme-main-btn" id="customThemesBtn">My Custom Themes</button>
        </div>
        
        <!-- GitHub Themes -->
        <div id="githubThemesSection" class="custom-items-section" style="display: none;">
          <h3>GitHub Themes</h3>
          <div class="theme-grid" id="githubThemesGrid">
            <!-- GitHub themes will be dynamically added here -->
          </div>
          <button class="btn apply-btn" id="applyGithubTheme" style="margin-top: 1rem;">Apply Selected Theme</button>
        </div>
        
        <!-- Upload Custom Theme -->
        <div id="uploadThemeSection" class="custom-items-section" style="display: none;">
          <h3>Upload Custom Theme</h3>
          <div class="upload-area" id="themeUpload">
            <input type="file" id="themeFile" accept=".css">
            <p>📄 Click to upload custom CSS theme</p>
          </div>
          <div class="upload-loading" id="themeUploadLoading">
            <div class="upload-spinner"></div>
            <span>Uploading theme...</span>
          </div>
          <button class="btn apply-btn" id="applyCustomTheme">Apply Custom Theme</button>
        </div>
        
        <!-- Custom Themes Management -->
        <div id="customThemesSection" class="custom-items-section" style="display: none;">
          <h3>📁 Your Custom Themes</h3>
          <div class="custom-items-grid" id="customThemesGrid">
            <!-- Custom themes will be dynamically added here -->
          </div>
        </div>
      </div>
      
      <!-- Surprises Subpage -->
      <div id="surprisesSubpage" class="theme-subpage">
        <button class="theme-back-btn" id="surprisesBackBtn">← Back</button>
        <h2>🎁 Set Surprises</h2>
        
        <div class="theme-main-buttons">
          <button class="theme-main-btn" id="githubSurprisesBtn">GitHub Surprises</button>
          <button class="theme-main-btn" id="uploadSurpriseBtn">Upload Custom Surprise</button>
          <button class="theme-main-btn" id="customSurprisesBtn">My Custom Surprises</button>
        </div>
        
        <!-- GitHub Surprises -->
        <div id="githubSurprisesSection" class="custom-items-section" style="display: none;">
          <h3>GitHub Surprises</h3>
          <div class="surprise-selector" id="githubSurprisesSelector">
            <!-- GitHub surprises will be dynamically added here -->
          </div>
          <button class="btn apply-btn" id="applyGithubSurprises" style="margin-top: 1rem;">Apply Selected Surprises</button>
        </div>
        
        <!-- Upload Custom Surprise -->
        <div id="uploadSurpriseSection" class="custom-items-section" style="display: none;">
          <h3>Upload Custom Surprise</h3>
          <div class="upload-area" id="surpriseUpload">
            <input type="file" id="surpriseFile" accept=".css">
            <p>📄 Click to upload custom CSS surprise</p>
          </div>
          <button class="btn apply-btn" id="applyCustomSurprise">Apply Custom Surprise</button>
        </div>
        
        <!-- Custom Surprises Management -->
        <div id="customSurprisesSection" class="custom-items-section" style="display: none;">
          <h3>📁 Your Custom Surprises</h3>
          <div class="custom-items-grid" id="customSurprisesGrid">
            <!-- Custom surprises will be dynamically added here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Library Section (Premium Only) -->
    <section id="librarySection" class="library-section section-transition">
      <div class="notice-box global-opacity-target">
        <h2>📚 Library</h2>
        
        <div class="library-tabs">
          <button class="library-tab active" data-tab="saved">💾 Saved Packs</button>
          <button class="library-tab" data-tab="history">📜 History</button>
          <button class="library-tab" data-tab="games">🎮 Games</button>
        </div>
        
        <div class="library-content">
          <div id="savedContent" class="tab-content active"></div>
          <div id="historyContent" class="tab-content" style="display: none;"></div>
          <div id="gamesContent" class="tab-content" style="display: none;">
            <div class="games-section">
              <h3>🎮 Mini Games</h3>
              <p>Check out these fun mini games:</p>
              <div class="games-grid">
                <div class="game-item" onclick="window.open('https://example.com/game1', '_blank')">
                  <h4>Game 1</h4>
                  <p>An exciting adventure game</p>
                </div>
                <div class="game-item" onclick="window.open('https://example.com/game2', '_blank')">
                  <h4>Game 2</h4>
                  <p>A challenging puzzle game</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Ads (Hidden for Premium Users) -->
    <div class="ads-footer-container global-opacity-target" aria-label="Advertisement">
      <div class="ads-footer-content">
        <div class="ads-placeholder">
          Loading advertisement...
        </div>
      </div>
    </div>
    
    <div class="footer-buttons-bottom global-opacity-target">
      <button class="footer-btn" id="aboutBtn">About</button>
      <button class="footer-btn" id="privacyBtn">Privacy Policy</button>
      <button class="footer-btn" id="contactBtn">Contact</button>
    </div>
    
    <div id="adsContainerBottom" class="global-opacity-target" aria-label="Advertisement">
      <div class="ads-placeholder">Advertisement Space</div>
    </div>
  </main>

  <!-- File Details Modal -->
  <div id="fileDetailsModal" class="file-details-modal">
    <div class="file-details-content global-opacity-target">
      <div class="file-details-header">
        <h2 id="fileDetailsTitle">File Details</h2>
        <button id="fileDetailsClose" class="header-btn">✕ Close</button>
      </div>
      <img id="fileDetailsThumbnail" class="file-details-thumbnail" src="" alt="">
      <div id="fileDetailsDescription" class="file-details-description">
        Loading description...
      </div>
      <div id="fileDetailsLinks" class="file-details-links">
        <!-- Links will be dynamically added here -->
      </div>
    </div>
  </div>

  <!-- Bottom Navigation (Premium Only) -->
  <nav class="bottom-nav global-opacity-target" id="bottomNav">
    <button class="nav-btn active" data-section="home">🏠 Home</button>
    <button class="nav-btn" data-section="theme">🎨 Theme</button>
    <button class="nav-btn" data-section="library">📚 Library</button>
  </nav>

  <!-- Premium Modal -->
  <div id="premiumModal" class="premium-modal">
    <div class="premium-content global-opacity-target">
      <div class="premium-header">
        <h2 class="premium-title">✨ Premium Upgrade</h2>
        <p class="premium-subtitle">Unlock all features for just $9.99/month</p>
      </div>

      <div class="premium-features">
        <h3>Premium Features:</h3>
        <ul>
          <li>Ad-free browsing experience</li>
          <li>Custom wallpapers and themes</li>
          <li>Save packs to your library</li>
          <li>Download history tracking</li>
          <li>Upload custom themes</li>
          <li>Priority support</li>
        </ul>
      </div>

      <div class="payment-form">
        <div class="form-group">
          <label for="cardNumber">Card Number</label>
          <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="expiry">Expiry Date</label>
            <input type="text" id="expiry" placeholder="MM/YY" maxlength="5">
          </div>
          <div class="form-group">
            <label for="cvv">CVV</label>
            <input type="text" id="cvv" placeholder="123" maxlength="4">
          </div>
        </div>
        
        <div class="form-group">
          <label for="cardName">Cardholder Name</label>
          <input type="text" id="cardName" placeholder="John Doe">
        </div>
        
        <div class="form-group">
          <label for="billingAddress">Billing Address</label>
          <input type="text" id="billingAddress" placeholder="City, Country">
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="agreeTerms">
          <label for="agreeTerms">I agree to the Terms of Service and Privacy Policy</label>
        </div>
      </div>

      <div class="premium-actions">
        <button class="premium-close" id="premiumClose">Cancel</button>
        <button class="premium-purchase" id="premiumPurchase" disabled>Purchase Premium</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" role="status" aria-live="polite">
    <div class="loading-spinner" aria-hidden="true"></div>
    <div id="loadingText">Loading packs...</div>
  </div>
  
  <!-- Downloading Screen -->
  <div id="downloadingScreen" role="dialog" aria-labelledby="downloadFileName" aria-modal="true">
    <div id="downloadBar" class="global-opacity-target">
      <div id="downloadFileName" role="heading"></div>
      <div id="progressBarContainer">
        <div id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div id="progressText" aria-live="polite"></div>
      <button id="downloadCancelBtn">Cancel Download</button>
    </div>
  </div>
  
  <!-- Footer Modal -->
  <div class="footer-modal" id="footerModal" role="dialog" aria-modal="true">
    <div class="footer-modal-content global-opacity-target" id="footerModalContent">
      <div class="accordion">
        <div class="accordion-item">
          <div class="accordion-header" data-accordion="about">
            About
            <span class="accordion-icon">▾</span>
          </div>
          <div class="accordion-content" data-accordion="about">
            Welcome to Minecraft File Manager! This website allows you to easily browse, search, and download Minecraft packs (.mcpack, .mcworld). We provide a simple and secure way for the Minecraft community to discover new content. All packs are carefully curated for your gameplay experience.
          </div>
        </div>
        
        <div class="accordion-item">
          <div class="accordion-header" data-accordion="privacy">
            Privacy Policy
            <span class="accordion-icon">▾</span>
          </div>
          <div class="accordion-content" data-accordion="privacy">
            Your privacy is important to us. We do not collect personal data from users. Some non-personal information may be collected by third-party services (like Google AdSense) for analytics and advertising purposes. For details, please review the privacy policies of these respective services.
          </div>
        </div>
        
        <div class="accordion-item">
          <div class="accordion-header" data-accordion="contact">
            Contact
            <span class="accordion-icon">▾</span>
          </div>
          <div class="accordion-content" data-accordion="contact">
            Have questions, feedback, or need support? You can reach out to us via email at <a href="mailto:nursifat3026@gmail.com" class="footer-contact-link">nursifat3026@gmail.com</a>. We appreciate your feedback and will respond as soon as possible.
          </div>
        </div>
      </div>
      <button class="footer-modal-back" id="footerModalBack">Close</button>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="help-modal">
    <div class="help-content global-opacity-target">
      <h2>Help</h2>
      <p>Use the search bar to find packs.<br>
      Filter by file type and sort order below the search.<br>
      Click Download to get the file.<br><br>
      <strong>Premium users</strong> can save packs, customize themes, and browse ad-free!</p>
      <button id="helpClose">Close</button>
    </div>
  </div>

  <script>
  // Premium System Application
  (function() {
    // Security Firewall and Protection
    class SecurityFirewall {
      constructor() {
        this.initSecurity();
      }
      
      initSecurity() {
        // Prevent XSS attacks
        this.sanitizeHTML = this.sanitizeHTML.bind(this);
        
        // Block common attack vectors
        this.blockMaliciousScripts();
        
        // Validate all inputs
        this.setupInputValidation();
        
        // Protect against clickjacking
        if (self !== top) {
          document.body.innerHTML = '<h1>Security Error: This page cannot be framed</h1>';
          throw new Error('Framing detected');
        }
      }
      
      sanitizeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }
      
      blockMaliciousScripts() {
        // Remove any script tags with suspicious content
        const scripts = document.getElementsByTagName('script');
        for (let i = 0; i < scripts.length; i++) {
          const script = scripts[i];
          const content = script.innerHTML.toLowerCase();
          
          // Block common attack patterns
          const dangerousPatterns = [
            /eval\(/i,
            /document\.cookie/i,
            /localStorage\.setItem/i,
            /XMLHttpRequest/i,
            /fetch\(/i,
            /<script.*?>.*?<\/script>/i
          ];
          
          for (const pattern of dangerousPatterns) {
            if (pattern.test(content)) {
              script.remove();
              console.warn('Blocked potentially dangerous script');
              break;
            }
          }
        }
      }
      
      setupInputValidation() {
        // Validate file inputs
        document.addEventListener('change', (e) => {
          if (e.target.type === 'file') {
            this.validateFileInput(e.target);
          }
        });
        
        // Validate text inputs
        document.addEventListener('input', (e) => {
          if (e.target.type === 'text' || e.target.type === 'password') {
            this.validateTextInput(e.target);
          }
        });
      }
      
      validateFileInput(input) {
        const file = input.files[0];
        if (!file) return;
        
        // Check file type
        const allowedTypes = {
          'image/*': ['wallpaperFile'],
          'text/css': ['themeFile', 'surpriseFile']
        };
        
        for (const [type, inputs] of Object.entries(allowedTypes)) {
          if (inputs.includes(input.id)) {
            if (!file.type.match(type) && type !== 'image/*') {
              input.value = '';
              premiumSystem.showNotification('Invalid file type. Please select a valid file.', 'error');
              return;
            }
          }
        }
        
        // Check file size (max 50MB for images, 5MB for CSS)
        let maxSize = input.id === 'wallpaperFile' ? 50 * 1024 * 1024 : 5 * 1024 * 1024;
        if (file.size > maxSize) {
          input.value = '';
          premiumSystem.showNotification(`File too large. Maximum size is ${maxSize/(1024*1024)}MB.`, 'error');
          return;
        }
      }
      
      validateTextInput(input) {
        // Remove potentially dangerous characters
        const dangerousChars = /[<>'"`]/g;
        if (dangerousChars.test(input.value)) {
          input.value = input.value.replace(dangerousChars, '');
          premiumSystem.showNotification('Removed invalid characters from input', 'warning');
        }
      }
    }

    // Constants
    const GH_USERNAME = "sifat8668";
    const REPOS = ["M-packs", "packs", "mom", "mcp", "getp", "somepack", "packes"];
    const CACHE_KEY = 'mc_packs_cache';
    const PREMIUM_KEY = 'mc_premium_status';
    const LIBRARY_KEY = 'mc_library';
    const HISTORY_KEY = 'mc_history';
    const THEME_KEY = 'mc_custom_themes';
    const WALLPAPER_KEY = 'mc_custom_wallpapers';
    const SURPRISE_KEY = 'mc_custom_surprises';
    const DOWNLOAD_HISTORY_KEY = 'mc_download_history';
    const VISIT_HISTORY_KEY = 'mc_visit_history';
    const CACHE_TIMEOUT = 30 * 60 * 1000; // 30 minutes

    // Test credit card for premium activation
    const TEST_CARD = {
      number: '3026203612490126',
      expiry: '02/34',
      cvv: '124',
      name: 'Sifatxalian',
      address: 'Chittagong, Bangladesh'
    };

    // Premium System
    class PremiumSystem {
      constructor() {
        this.security = new SecurityFirewall();
        this.isPremium = this.checkPremiumStatus();
        this.library = this.getLibrary();
        this.history = this.getHistory();
        this.customThemes = this.getCustomThemes();
        this.customWallpapers = this.getCustomWallpapers();
        this.customSurprises = this.getCustomSurprises();
        this.downloadHistory = this.getDownloadHistory();
        this.currentSurprises = [];
        this.surpriseTimer = null;
        this.customThemeApplied = false;
        
        // Record visit
        this.recordVisit();
        
        // Load saved customizations immediately
        this.loadSavedCustomizations();
        
        if (this.isPremium) {
          this.activatePremiumFeatures();
        }
        
        this.setupPremiumUI();
        this.setupThemeSystem();
        this.setupLibrarySystem();
        this.showRandomPromo();
        this.setupOpacityControls();
        this.setupFontSizeControls();
        this.setupTrendFilter();
        this.setupSurpriseSystem();
        this.setupTimedButtons();
        this.setupCustomItemsManagement();
        this.setupAccordion();
        this.setupBackgroundMovement();
        this.setupDynamicTitleShadow();
        this.setupFileDetailsModal();
        this.setupSectionTransitions();
      }

      setupBackgroundMovement() {
        window.addEventListener('scroll', () => {
          const scrolled = window.pageYOffset;
          if (scrolled > 10) {
            document.body.style.backgroundPosition = `center ${10}px`;
          } else {
            document.body.style.backgroundPosition = 'center top';
          }
        });
      }

      setupFileDetailsModal() {
        const modal = document.getElementById('fileDetailsModal');
        const closeBtn = document.getElementById('fileDetailsClose');
        
        closeBtn.addEventListener('click', () => {
          modal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      }

setupDynamicTitleShadow() {
  const updateTitleShadow = () => {
    const header = document.querySelector('header');
    const bgColor = getComputedStyle(header).backgroundColor;
    const rgb = bgColor.match(/\d+/g);
    
    if (rgb) {
      const brightness = (parseInt(rgb[0]) * 299 + parseInt(rgb[1]) * 587 + parseInt(rgb[2]) * 114) / 1000;
      const shadowColor = brightness > 128 ? 'black' : 'white';
      document.documentElement.style.setProperty('--shadow-color', shadowColor);
    }
  };
  
  updateTitleShadow();
  setInterval(updateTitleShadow, 1000);
}

      setupSectionTransitions() {
        // This will be handled in the switchSection method
      }

      recordVisit() {
        const visitHistory = JSON.parse(localStorage.getItem(VISIT_HISTORY_KEY) || '[]');
        const now = new Date();
        const visit = {
          timestamp: now.toISOString(),
          date: now.toLocaleDateString(),
          time: now.toLocaleTimeString()
        };
        
        visitHistory.unshift(visit);
        // Keep only last 100 visits
        if (visitHistory.length > 100) {
          visitHistory.splice(100);
        }
        
        localStorage.setItem(VISIT_HISTORY_KEY, JSON.stringify(visitHistory));
      }

      checkPremiumStatus() {
        const premiumData = localStorage.getItem(PREMIUM_KEY);
        if (premiumData) {
          try {
            const data = JSON.parse(premiumData);
            const now = Date.now();
            const expiry = data.expiry;
            
            if (now < expiry) {
              // Set verification elements for premium
              this.setPremiumVerification();
              return true;
            } else {
              // Premium expired
              localStorage.removeItem(PREMIUM_KEY);
              this.clearPremiumVerification();
              return false;
            }
          } catch (e) {
            console.error('Error parsing premium data:', e);
            localStorage.removeItem(PREMIUM_KEY);
            return false;
          }
        }
        this.clearPremiumVerification();
        return false;
      }

      setPremiumVerification() {
        // Set verification elements for premium (invisible)
        document.getElementById('premiumVerification1').textContent = 'premium-active-1';
        document.getElementById('premiumVerification2').textContent = 'premium-active-2';
        document.getElementById('premiumVerification3').textContent = 'premium-active-3';
      }

      clearPremiumVerification() {
        // Clear verification elements
        document.getElementById('premiumVerification1').textContent = '';
        document.getElementById('premiumVerification2').textContent = '';
        document.getElementById('premiumVerification3').textContent = '';
      }

      activatePremium(duration = 30 * 24 * 60 * 60 * 1000) { // 30 days
        const now = Date.now();
        const premiumData = {
          activated: now,
          expiry: now + duration,
          plan: 'monthly'
        };
        
        localStorage.setItem(PREMIUM_KEY, JSON.stringify(premiumData));
        this.isPremium = true;
        this.setPremiumVerification();
        this.activatePremiumFeatures();
        this.addToHistory('Premium activated', 'premium');
        
        // Update UI
        this.updatePremiumButton();
        document.getElementById('premiumModal').style.display = 'none';
        
        // Show success message
        this.showNotification('🎉 Premium activated successfully! Welcome to Premium!', 'success');
      }

      activatePremiumFeatures() {
        document.body.classList.add('premium-user');
        document.getElementById('bottomNav').classList.add('show');
        document.getElementById('trendFilterContainer').style.display = 'inline-block';
        this.updatePremiumButton();
      }

      updatePremiumButton() {
        const premiumBtn = document.getElementById('premiumBtn');
        if (this.isPremium) {
          premiumBtn.textContent = '✨ Premium';
          premiumBtn.className = 'header-btn premium-status';
          premiumBtn.onclick = null;
        } else {
          premiumBtn.textContent = '✨ Get Premium';
          premiumBtn.className = 'header-btn premium-btn';
          premiumBtn.onclick = () => this.showPremiumModal();
        }
      }

      setupPremiumUI() {
        // Premium button
        this.updatePremiumButton();
        if (!this.isPremium) {
          document.getElementById('premiumBtn').onclick = () => this.showPremiumModal();
        }

        // Premium modal
        document.getElementById('premiumClose').onclick = () => this.hidePremiumModal();
        document.getElementById('premiumPurchase').onclick = () => this.processPurchase();
        
        // Form validation
        const inputs = ['cardNumber', 'expiry', 'cvv', 'cardName', 'billingAddress'];
        const agreeTerms = document.getElementById('agreeTerms');
        const purchaseBtn = document.getElementById('premiumPurchase');
        
        function validateForm() {
          const allFilled = inputs.every(id => document.getElementById(id).value.trim() !== '');
          const termsChecked = agreeTerms.checked;
          purchaseBtn.disabled = !(allFilled && termsChecked);
        }
        
        inputs.forEach(id => {
          document.getElementById(id).addEventListener('input', validateForm);
        });
        agreeTerms.addEventListener('change', validateForm);

        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', (e) => {
          let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
          let matches = value.match(/\d{4,16}/g);
          let match = matches && matches[0] || '';
          let parts = [];
          for (let i = 0, len = match.length; i < len; i += 4) {
            parts.push(match.substring(i, i + 4));
          }
          if (parts.length) {
            e.target.value = parts.join(' ');
          } else {
            e.target.value = value;
          }
        });

        // Format expiry date
        document.getElementById('expiry').addEventListener('input', (e) => {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.substring(0,2) + '/' + value.substring(2,4);
          }
          e.target.value = value;
        });

        // Navigation - Only allow premium users to access theme and library
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const section = e.target.getAttribute('data-section');
            
            // Check if user has access to the section
            if ((section === 'theme' || section === 'library') && !this.isPremium) {
              this.showNotification('This feature is for Premium users only. Upgrade to access!', 'error');
              this.showPremiumModal();
              return;
            }
            
            this.switchSection(section);
          });
        });

        // Premium promo
        document.getElementById('premiumPromo').onclick = () => this.showPremiumModal();
      }

      showRandomPromo() {
        if (!this.isPremium && Math.random() < 0.3) { // 30% chance
          document.getElementById('premiumPromo').style.display = 'block';
        }
      }

      showPremiumModal() {
        document.getElementById('premiumModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      hidePremiumModal() {
        document.getElementById('premiumModal').style.display = 'none';
        document.body.style.overflow = '';
      }

      processPurchase() {
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const expiry = document.getElementById('expiry').value;
        const cvv = document.getElementById('cvv').value;
        const cardName = document.getElementById('cardName').value.trim();
        const billingAddress = document.getElementById('billingAddress').value.trim();

        // Validate against test card
        if (cardNumber === TEST_CARD.number &&
            expiry === TEST_CARD.expiry &&
            cvv === TEST_CARD.cvv &&
            cardName.toLowerCase() === TEST_CARD.name.toLowerCase() &&
            billingAddress.toLowerCase() === TEST_CARD.address.toLowerCase()) {
          
          // Simulate processing
          const purchaseBtn = document.getElementById('premiumPurchase');
          const originalText = purchaseBtn.textContent;
          purchaseBtn.textContent = 'Processing...';
          purchaseBtn.disabled = true;
          
          setTimeout(() => {
            this.activatePremium();
            purchaseBtn.textContent = originalText;
          }, 2000);
          
        } else {
          this.showNotification('❌ Invalid card details. Please check and try again.', 'error');
        }
      }

      switchSection(section) {
        // Hide all sections with transition
        document.querySelectorAll('.section-transition').forEach(sec => {
          sec.classList.remove('active');
        });
        
        // Update navigation
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-section="${section}"]`).classList.add('active');

        // Show the target section with delay for transition
        setTimeout(() => {
          document.getElementById('homeSection').style.display = section === 'home' ? 'block' : 'none';
          document.getElementById('themeSection').style.display = section === 'theme' ? 'block' : 'none';
          document.getElementById('librarySection').style.display = section === 'library' ? 'block' : 'none';
          
          // Add active class for transition
          setTimeout(() => {
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
              targetSection.classList.add('active');
            }
          }, 50);
        }, 300);
        
        // Reset theme subpages when switching to theme section
        if (section === 'theme') {
          this.resetThemeSubpages();
        }
      }

      // Theme System - NEW DESIGN
      setupThemeSystem() {
        // Main theme buttons
        document.getElementById('setWallpaperBtn').addEventListener('click', () => {
          this.showThemeSubpage('wallpaperSubpage');
        });
        
        document.getElementById('setThemeBtn').addEventListener('click', () => {
          this.showThemeSubpage('themeSubpage');
        });
        
        document.getElementById('setSurprisesBtn').addEventListener('click', () => {
          this.showThemeSubpage('surprisesSubpage');
        });
        
        // Wallpaper subpage buttons
        document.getElementById('githubWallpapersBtn').addEventListener('click', () => {
          this.showWallpaperSection('githubWallpapersSection');
          this.loadGitHubWallpapers();
        });
        
        document.getElementById('uploadWallpaperBtn').addEventListener('click', () => {
          this.showWallpaperSection('uploadWallpaperSection');
        });
        
        document.getElementById('customWallpapersBtn').addEventListener('click', () => {
          this.showWallpaperSection('customWallpapersSection');
          this.renderCustomWallpapers();
        });
        
        // Theme subpage buttons
        document.getElementById('githubThemesBtn').addEventListener('click', () => {
          this.showThemeSection('githubThemesSection');
          this.loadGitHubThemes();
        });
        
        document.getElementById('uploadThemeBtn').addEventListener('click', () => {
          this.showThemeSection('uploadThemeSection');
        });
        
        document.getElementById('customThemesBtn').addEventListener('click', () => {
          this.showThemeSection('customThemesSection');
          this.renderCustomThemes();
        });
        
        // Surprises subpage buttons
        document.getElementById('githubSurprisesBtn').addEventListener('click', () => {
          this.showSurpriseSection('githubSurprisesSection');
          this.loadGitHubSurprises();
        });
        
        document.getElementById('uploadSurpriseBtn').addEventListener('click', () => {
          this.showSurpriseSection('uploadSurpriseSection');
        });
        
        document.getElementById('customSurprisesBtn').addEventListener('click', () => {
          this.showSurpriseSection('customSurprisesSection');
          this.renderCustomSurprises();
        });
        
        // Back buttons
        document.getElementById('wallpaperBackBtn').addEventListener('click', () => {
          this.hideThemeSubpage('wallpaperSubpage');
        });
        
        document.getElementById('themeBackBtn').addEventListener('click', () => {
          this.hideThemeSubpage('themeSubpage');
        });
        
        document.getElementById('surprisesBackBtn').addEventListener('click', () => {
          this.hideThemeSubpage('surprisesSubpage');
        });
        
        // Wallpaper upload
        document.getElementById('wallpaperUpload').onclick = () => {
          document.getElementById('wallpaperFile').click();
        };

        document.getElementById('wallpaperFile').addEventListener('change', (e) => {
          this.uploadWallpaper(e.target.files[0], true);
        });

        // Theme upload
        document.getElementById('themeUpload').onclick = () => {
          document.getElementById('themeFile').click();
        };

        document.getElementById('themeFile').addEventListener('change', (e) => {
          this.uploadTheme(e.target.files[0], true);
        });

        // Surprise upload
        document.getElementById('surpriseUpload').onclick = () => {
          document.getElementById('surpriseFile').click();
        };

        document.getElementById('surpriseFile').addEventListener('change', (e) => {
          this.uploadSurprise(e.target.files[0], true);
        });

        // Apply buttons
        document.getElementById('applyGithubWallpaper').onclick = () => this.applySelectedGitHubWallpaper();
        document.getElementById('applyCustomWallpaper').onclick = () => this.applyCustomWallpaper();
        document.getElementById('applyGithubTheme').onclick = () => this.applySelectedGitHubTheme();
        document.getElementById('applyCustomTheme').onclick = () => this.applyCustomTheme();
        document.getElementById('applyGithubSurprises').onclick = () => this.applySelectedGitHubSurprises();
        document.getElementById('applyCustomSurprise').onclick = () => this.applyCustomSurprise();

        // Reset buttons
        document.getElementById('resetWallpaperBtn').onclick = () => this.resetWallpaper();
        document.getElementById('resetThemeBtn').onclick = () => this.resetTheme();
        document.getElementById('resetSurprisesBtn').onclick = () => this.resetSurprises();
        document.getElementById('resetFontSizeBtn').onclick = () => this.resetFontSize();
      }

      showThemeSubpage(subpageId) {
        // Hide all subpages first
        document.querySelectorAll('.theme-subpage').forEach(subpage => {
          subpage.style.display = 'none';
        });
        
        // Hide all sections within subpages
        document.querySelectorAll('.custom-items-section').forEach(section => {
          section.style.display = 'none';
        });
        
        // Show the selected subpage
        document.getElementById(subpageId).style.display = 'block';
      }

      hideThemeSubpage(subpageId) {
        document.getElementById(subpageId).style.display = 'none';
      }

      resetThemeSubpages() {
        // Hide all subpages
        document.querySelectorAll('.theme-subpage').forEach(subpage => {
          subpage.style.display = 'none';
        });
        
        // Hide all sections within subpages
        document.querySelectorAll('.custom-items-section').forEach(section => {
          section.style.display = 'none';
        });
      }

      showWallpaperSection(sectionId) {
        // Hide all wallpaper sections
        document.getElementById('githubWallpapersSection').style.display = 'none';
        document.getElementById('uploadWallpaperSection').style.display = 'none';
        document.getElementById('customWallpapersSection').style.display = 'none';
        
        // Show the selected section
        document.getElementById(sectionId).style.display = 'block';
      }

      showThemeSection(sectionId) {
        // Hide all theme sections
        document.getElementById('githubThemesSection').style.display = 'none';
        document.getElementById('uploadThemeSection').style.display = 'none';
        document.getElementById('customThemesSection').style.display = 'none';
        
        // Show the selected section
        document.getElementById(sectionId).style.display = 'block';
      }

      showSurpriseSection(sectionId) {
        // Hide all surprise sections
        document.getElementById('githubSurprisesSection').style.display = 'none';
        document.getElementById('uploadSurpriseSection').style.display = 'none';
        document.getElementById('customSurprisesSection').style.display = 'none';
        
        // Show the selected section
        document.getElementById(sectionId).style.display = 'block';
      }

      setupOpacityControls() {
        const globalOpacitySlider = document.getElementById('globalOpacity');
        const globalOpacityValue = document.getElementById('globalOpacityValue');

        // Load saved opacity values
        const savedGlobalOpacity = localStorage.getItem('globalOpacity') || 100;
        
        globalOpacitySlider.value = savedGlobalOpacity;
        globalOpacityValue.textContent = savedGlobalOpacity + '%';
        
        document.documentElement.style.setProperty('--global-opacity', savedGlobalOpacity / 100);

        // Global opacity slider
        globalOpacitySlider.addEventListener('input', (e) => {
          const value = e.target.value;
          globalOpacityValue.textContent = value + '%';
          document.documentElement.style.setProperty('--global-opacity', value / 100);
          localStorage.setItem('globalOpacity', value);
        });
      }

      setupFontSizeControls() {
        const globalFontSizeSlider = document.getElementById('globalFontSize');
        const globalFontSizeValue = document.getElementById('globalFontSizeValue');

        // Load saved font size values
        const savedGlobalFontSize = localStorage.getItem('globalFontSize') || 16;
        
        globalFontSizeSlider.value = savedGlobalFontSize;
        globalFontSizeValue.textContent = savedGlobalFontSize + 'px';
        
        document.documentElement.style.setProperty('--font-size', savedGlobalFontSize + 'px');

        // Global font size slider
        globalFontSizeSlider.addEventListener('input', (e) => {
          const value = e.target.value;
          globalFontSizeValue.textContent = value + 'px';
          document.documentElement.style.setProperty('--font-size', value + 'px');
          localStorage.setItem('globalFontSize', value);
        });
      }

      resetFontSize() {
        const globalFontSizeSlider = document.getElementById('globalFontSize');
        const globalFontSizeValue = document.getElementById('globalFontSizeValue');
        
        globalFontSizeSlider.value = 16;
        globalFontSizeValue.textContent = '16px';
        document.documentElement.style.setProperty('--font-size', '16px');
        localStorage.setItem('globalFontSize', 16);
        
        this.showNotification('Font size reset to default!', 'success');
      }

      setupTrendFilter() {
        if (!this.isPremium) return;

        const trendButton = document.getElementById('trendButton');
        const trendOptions = document.getElementById('trendOptions');

        trendButton.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown(trendButton, trendOptions);
        });

        trendOptions.addEventListener('click', (e) => {
          if (e.target.classList.contains('dropdown-option')) {
            this.selectOption(e.target, trendButton, trendOptions);
            fileManager.currentTrendFilter = e.target.getAttribute('data-value');
            fileManager.applyFiltersAndSearch();
          }
        });
      }

      setupSurpriseSystem() {
        // Start surprise timer if surprises are active
        const activeSurprises = JSON.parse(localStorage.getItem('active_surprises') || '[]');
        if (activeSurprises.length > 0) {
          this.currentSurprises = activeSurprises;
          this.startSurpriseTimer();
        }
      }

      setupTimedButtons() {
        // Reset button every 7 minutes for 15 seconds
        setInterval(() => {
          if (this.customThemeApplied) {
            this.showTimedButton('timedResetBtn', 'Reset Theme');
          }
        }, 7 * 60 * 1000); // 7 minutes

        // Contact button every 1.5 minutes for 15 seconds
        setInterval(() => {
          this.showTimedButton('timedContactBtn', 'Contact Support');
        }, 90 * 1000); // 1.5 minutes

        // Set up button handlers
        document.getElementById('timedResetBtn').onclick = () => {
          this.resetTheme();
          this.hideTimedButton('timedResetBtn');
        };

        document.getElementById('timedContactBtn').onclick = () => {
          document.getElementById('contactBtn').click();
          this.hideTimedButton('timedContactBtn');
        };
      }

      setupCustomItemsManagement() {
        // This will be used to render custom items in their respective grids
      }

      setupAccordion() {
        document.querySelectorAll('.accordion-header').forEach(header => {
          header.addEventListener('click', () => {
            const accordionId = header.getAttribute('data-accordion');
            const content = document.querySelector(`.accordion-content[data-accordion="${accordionId}"]`);
            
            // Toggle active class
            header.classList.toggle('active');
            content.classList.toggle('active');
            
            // Close other accordions
            document.querySelectorAll('.accordion-header').forEach(otherHeader => {
              if (otherHeader !== header) {
                otherHeader.classList.remove('active');
              }
            });
            
            document.querySelectorAll('.accordion-content').forEach(otherContent => {
              if (otherContent !== content) {
                otherContent.classList.remove('active');
              }
            });
          });
        });
      }

      showTimedButton(buttonId, text) {
        const button = document.getElementById(buttonId);
        button.textContent = text;
        button.style.display = 'block';
        
        // Hide after 15 seconds
        setTimeout(() => {
          this.hideTimedButton(buttonId);
        }, 15000);
      }

      hideTimedButton(buttonId) {
        document.getElementById(buttonId).style.display = 'none';
      }

      toggleDropdown(button, options) {
        const isOpen = button.classList.contains('open');
        this.closeAllDropdowns();
        if (!isOpen) {
          button.classList.add('open');
          options.classList.add('open');
          button.setAttribute('aria-expanded', 'true');
        }
      }

      closeAllDropdowns() {
        document.querySelectorAll('.dropdown-button').forEach(btn => {
          btn.classList.remove('open');
          btn.setAttribute('aria-expanded', 'false');
        });
        document.querySelectorAll('.dropdown-options').forEach(options => {
          options.classList.remove('open');
        });
      }

      selectOption(option, button, optionsContainer) {
        optionsContainer.querySelectorAll('.dropdown-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
        button.querySelector('.dropdown-text').textContent = option.textContent;
        this.closeAllDropdowns();
      }

      async loadGitHubWallpapers() {
        const grid = document.getElementById('githubWallpapersGrid');
        grid.innerHTML = '';
        
        // Load wallpapers from repo (1-25)
        for (let i = 1; i <= 25; i++) {
          const wallpaperItem = document.createElement('div');
          wallpaperItem.className = 'wallpaper-item';
          wallpaperItem.setAttribute('data-value', `wallpaper${i}`);
          
          // Try different image formats
          const jpgUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${i}.jpg`;
          const pngUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${i}.png`;
          const jpegUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${i}.jpeg`;
          const gifUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${i}.gif`;
          
          wallpaperItem.innerHTML = `
            <img src="${jpgUrl}" alt="Wallpaper ${i}" onerror="this.src='${pngUrl}'; this.onerror=function(){this.src='${jpegUrl}'; this.onerror=function(){this.src='${gifUrl}'; this.onerror=function(){this.src=''; this.alt='Image not available'}}}">
            <div style="text-align: center; padding: 0.5rem;">Wallpaper ${i}</div>
          `;
          
          wallpaperItem.addEventListener('click', () => {
            document.querySelectorAll('.wallpaper-item').forEach(item => {
              item.classList.remove('selected');
            });
            wallpaperItem.classList.add('selected');
          });
          
          grid.appendChild(wallpaperItem);
        }
      }

      async loadGitHubThemes() {
        const grid = document.getElementById('githubThemesGrid');
        grid.innerHTML = '';
        
        // Load themes from repo (1-15)
        for (let i = 1; i <= 15; i++) {
          const themeItem = document.createElement('div');
          themeItem.className = 'theme-item';
          themeItem.setAttribute('data-value', `theme${i}`);
          themeItem.innerHTML = `
            <h4>Theme ${i}</h4>
            <p>GitHub Theme ${i}</p>
          `;
          
          themeItem.addEventListener('click', () => {
            document.querySelectorAll('.theme-item').forEach(item => {
              item.classList.remove('selected');
            });
            themeItem.classList.add('selected');
          });
          
          grid.appendChild(themeItem);
        }
      }

      async loadGitHubSurprises() {
        const selector = document.getElementById('githubSurprisesSelector');
        selector.innerHTML = '';
        
        // Load surprises from repo (1-10)
        for (let i = 1; i <= 10; i++) {
          const surpriseCheckbox = document.createElement('input');
          surpriseCheckbox.type = 'checkbox';
          surpriseCheckbox.className = 'surprise-checkbox';
          surpriseCheckbox.id = `github-surprise-${i}`;
          surpriseCheckbox.setAttribute('data-value', `surprise${i}`);
          
          const surpriseLabel = document.createElement('label');
          surpriseLabel.className = 'surprise-checkbox-label';
          surpriseLabel.setAttribute('for', `github-surprise-${i}`);
          surpriseLabel.textContent = `Surprise ${i}`;
          
          const surpriseContainer = document.createElement('div');
          surpriseContainer.appendChild(surpriseCheckbox);
          surpriseContainer.appendChild(surpriseLabel);
          
          selector.appendChild(surpriseContainer);
        }
      }

      async applySelectedGitHubWallpaper() {
        const selectedWallpaper = document.querySelector('.wallpaper-item.selected');
        if (!selectedWallpaper) {
          this.showNotification('Please select a wallpaper first!', 'error');
          return;
        }

        const wallpaperNumber = selectedWallpaper.getAttribute('data-value').replace('wallpaper', '');
        
        // Try different image formats
        const jpgUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${wallpaperNumber}.jpg`;
        const pngUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${wallpaperNumber}.png`;
        const jpegUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${wallpaperNumber}.jpeg`;
        const gifUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/wallpaper${wallpaperNumber}.gif`;
        
        // Test which format exists
        const testImage = (url) => {
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(url);
            img.onerror = () => resolve(null);
            img.src = url;
          });
        };
        
        let wallpaperUrl = await testImage(jpgUrl);
        if (!wallpaperUrl) wallpaperUrl = await testImage(pngUrl);
        if (!wallpaperUrl) wallpaperUrl = await testImage(jpegUrl);
        if (!wallpaperUrl) wallpaperUrl = await testImage(gifUrl);
        
        if (!wallpaperUrl) {
          this.showNotification('Wallpaper not found on GitHub!', 'error');
          return;
        }
        
        document.body.classList.add('custom-bg');
        document.body.style.setProperty('--custom-bg-url', `url(${wallpaperUrl})`);
        localStorage.setItem('selected_wallpaper', wallpaperUrl);
        
        this.addToHistory(`Applied GitHub wallpaper: ${selectedWallpaper.getAttribute('data-value')}`, 'theme');
        this.showNotification(`Applied Wallpaper ${wallpaperNumber}!`, 'success');
      }

      async applySelectedGitHubTheme() {
        const selectedTheme = document.querySelector('.theme-item.selected');
        if (!selectedTheme) {
          this.showNotification('Please select a theme first!', 'error');
          return;
        }

        const themeNumber = selectedTheme.getAttribute('data-value').replace('theme', '');
        const themeUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/theme${themeNumber}.css`;
        
        try {
          const response = await fetch(themeUrl);
          if (!response.ok) throw new Error('Theme not found');
          
          const css = await response.text();
          
          this.applyCustomTheme({css: css, name: `GitHub Theme ${themeNumber}`});
        } catch (error) {
          console.error('Error loading theme:', error);
          this.showNotification('Error loading theme from GitHub', 'error');
        }
      }

      async applySelectedGitHubSurprises() {
        const selectedSurprises = document.querySelectorAll('.surprise-checkbox:checked');
        if (selectedSurprises.length === 0) {
          this.showNotification('Please select at least one surprise!', 'error');
          return;
        }
        
        if (selectedSurprises.length > 5) {
          this.showNotification('You can only select up to 5 surprises at once!', 'error');
          return;
        }

        const surprisePromises = Array.from(selectedSurprises).map(async (checkbox) => {
          const surpriseNumber = checkbox.getAttribute('data-value').replace('surprise', '');
          const surpriseUrl = `https://raw.githubusercontent.com/sifat8668/M-packs/main/surprise${surpriseNumber}.css`;
          
          try {
            const response = await fetch(surpriseUrl);
            if (!response.ok) throw new Error('Surprise not found');
            
            const css = await response.text();
            return {css: css, name: `GitHub Surprise ${surpriseNumber}`};
          } catch (error) {
            console.error('Error loading surprise:', error);
            return null;
          }
        });

        const surprises = await Promise.all(surprisePromises);
        const validSurprises = surprises.filter(s => s !== null);
        
        if (validSurprises.length === 0) {
          this.showNotification('No valid surprises found!', 'error');
          return;
        }
        
        this.applySurprises(validSurprises);
      }

      uploadWallpaper(file, applyAfterUpload = false) {
        if (!file) return;
        
        const uploadLoading = document.getElementById('wallpaperUploadLoading');
        uploadLoading.style.display = 'flex';
        
        // Simulate upload (in a real app, this would upload to a server)
        setTimeout(() => {
          uploadLoading.style.display = 'none';
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const wallpaperData = {
              name: file.name,
              url: e.target.result,
              uploadedAt: new Date().toISOString()
            };
            
            this.addCustomWallpaper(wallpaperData);
            
            if (applyAfterUpload) {
              this.applyCustomWallpaper(wallpaperData);
            } else {
              this.showNotification('Wallpaper uploaded successfully!', 'success');
            }
          };
          
          reader.readAsDataURL(file);
        }, 2000);
      }

      uploadTheme(file, applyAfterUpload = false) {
        if (!file) return;
        
        const uploadLoading = document.getElementById('themeUploadLoading');
        uploadLoading.style.display = 'flex';
        
        // Simulate upload (in a real app, this would upload to a server)
        setTimeout(() => {
          uploadLoading.style.display = 'none';
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const themeData = {
              name: file.name.replace('.css', ''),
              css: e.target.result,
              uploadedAt: new Date().toISOString()
            };
            
            this.addCustomTheme(themeData);
            
            if (applyAfterUpload) {
              this.applyCustomTheme(themeData);
            } else {
              this.showNotification('Theme uploaded successfully!', 'success');
            }
          };
          
          reader.readAsText(file);
        }, 2000);
      }

      uploadSurprise(file, applyAfterUpload = false) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const surpriseData = {
            name: file.name.replace('.css', ''),
            css: e.target.result,
            uploadedAt: new Date().toISOString()
          };
          
          this.addCustomSurprise(surpriseData);
          
          if (applyAfterUpload) {
            this.applyCustomSurprise(surpriseData);
          } else {
            this.showNotification('Surprise uploaded successfully!', 'success');
          }
        };
        
        reader.readAsText(file);
      }

      applyCustomWallpaper(wallpaperData = null) {
        if (!wallpaperData) {
          const customWallpapers = this.getCustomWallpapers();
          if (customWallpapers.length === 0) {
            this.showNotification('No custom wallpapers available!', 'error');
            return;
          }
          
          // For simplicity, apply the first custom wallpaper
          wallpaperData = customWallpapers[0];
        }
        
        document.body.classList.add('custom-bg');
        document.body.style.setProperty('--custom-bg-url', `url(${wallpaperData.url})`);
        localStorage.setItem('selected_wallpaper', wallpaperData.url);
        
        this.addToHistory(`Applied custom wallpaper: ${wallpaperData.name}`, 'theme');
        this.showNotification(`Applied ${wallpaperData.name}!`, 'success');
      }

      applyCustomTheme(themeData = null) {
        if (!themeData) {
          const customThemes = this.getCustomThemes();
          if (customThemes.length === 0) {
            this.showNotification('No custom themes available!', 'error');
            return;
          }
          
          // For simplicity, apply the first custom theme
          themeData = customThemes[0];
        }
        
        const style = document.createElement('style');
        style.id = 'custom-theme';
        style.textContent = themeData.css;
        document.head.appendChild(style);
        
        this.customThemeApplied = true;
        localStorage.setItem('custom_theme', JSON.stringify(themeData));
        
        this.addToHistory(`Applied custom theme: ${themeData.name}`, 'theme');
        this.showNotification(`Applied ${themeData.name}!`, 'success');
      }

      applyCustomSurprise(surpriseData = null) {
        if (!surpriseData) {
          const customSurprises = this.getCustomSurprises();
          if (customSurprises.length === 0) {
            this.showNotification('No custom surprises available!', 'error');
            return;
          }
          
          // For simplicity, apply the first custom surprise
          surpriseData = customSurprises[0];
        }
        
        this.applySurprises([surpriseData]);
      }

      applySurprises(surprises) {
        // Clear existing surprises
        this.clearSurprises();
        
        // Apply new surprises
        surprises.forEach((surprise, index) => {
          const style = document.createElement('style');
          style.id = `custom-surprise-${index}`;
          style.textContent = surprise.css;
          document.head.appendChild(style);
          
          this.currentSurprises.push(surprise);
        });
        
        localStorage.setItem('active_surprises', JSON.stringify(this.currentSurprises));
        
        // Start surprise timer
        this.startSurpriseTimer();
        
        this.addToHistory(`Applied ${surprises.length} surprise(s)`, 'theme');
        this.showNotification(`Applied ${surprises.length} surprise(s)!`, 'success');
      }

      clearSurprises() {
        // Remove all surprise styles
        document.querySelectorAll('style[id^="custom-surprise-"]').forEach(style => {
          style.remove();
        });
        
        this.currentSurprises = [];
        localStorage.removeItem('active_surprises');
        
        if (this.surpriseTimer) {
          clearInterval(this.surpriseTimer);
          this.surpriseTimer = null;
        }
      }

      startSurpriseTimer() {
        if (this.surpriseTimer) clearInterval(this.surpriseTimer);
        
        this.surpriseTimer = setInterval(() => {
          if (this.currentSurprises.length > 0) {
            this.triggerRandomSurprise();
          }
        }, 60000); // Trigger a surprise every minute
      }

      triggerRandomSurprise() {
        if (this.currentSurprises.length === 0) return;
        
        const randomIndex = Math.floor(Math.random() * this.currentSurprises.length);
        const surprise = this.currentSurprises[randomIndex];
        
        // Create a temporary element to apply the surprise effect
        const surpriseEffect = document.createElement('div');
        surpriseEffect.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 9999;
          animation: surpriseEffect 3s ease-in-out forwards;
        `;
        
        // Add surprise-specific styles
        if (surprise.name.includes('confetti')) {
          surpriseEffect.innerHTML = `
            <style>
              @keyframes surpriseEffect {
                0% { background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%); }
                100% { background: radial-gradient(circle, rgba(255,255,255,0) 0%, transparent 70%); }
              }
            </style>
          `;
        } else if (surprise.name.includes('sparkle')) {
          surpriseEffect.innerHTML = `
            <style>
              @keyframes surpriseEffect {
                0% { box-shadow: inset 0 0 100px rgba(255,215,0,0.5); }
                100% { box-shadow: inset 0 0 100px rgba(255,215,0,0); }
              }
            </style>
          `;
        } else {
          // Default surprise effect
          surpriseEffect.innerHTML = `
            <style>
              @keyframes surpriseEffect {
                0% { backdrop-filter: blur(0px); }
                50% { backdrop-filter: blur(10px); }
                100% { backdrop-filter: blur(0px); }
              }
            </style>
          `;
        }
        
        document.body.appendChild(surpriseEffect);
        
        setTimeout(() => {
          surpriseEffect.remove();
        }, 3000);
      }

      resetWallpaper() {
        document.body.classList.remove('custom-bg');
        document.body.style.removeProperty('--custom-bg-url');
        localStorage.removeItem('selected_wallpaper');
        
        this.showNotification('Wallpaper reset to default!', 'success');
      }

      resetTheme() {
        const customTheme = document.getElementById('custom-theme');
        if (customTheme) {
          customTheme.remove();
        }
        
        this.customThemeApplied = false;
        localStorage.removeItem('custom_theme');
        
        this.showNotification('Theme reset to default!', 'success');
      }

      resetSurprises() {
        this.clearSurprises();
        this.showNotification('Surprises cleared!', 'success');
      }

      addCustomWallpaper(wallpaper) {
        const wallpapers = this.getCustomWallpapers();
        wallpapers.push(wallpaper);
        localStorage.setItem(WALLPAPER_KEY, JSON.stringify(wallpapers));
        this.customWallpapers = wallpapers;
      }

      addCustomTheme(theme) {
        const themes = this.getCustomThemes();
        themes.push(theme);
        localStorage.setItem(THEME_KEY, JSON.stringify(themes));
        this.customThemes = themes;
      }

      addCustomSurprise(surprise) {
        const surprises = this.getCustomSurprises();
        surprises.push(surprise);
        localStorage.setItem(SURPRISE_KEY, JSON.stringify(surprises));
        this.customSurprises = surprises;
      }

      getCustomWallpapers() {
        return JSON.parse(localStorage.getItem(WALLPAPER_KEY) || '[]');
      }

      getCustomThemes() {
        return JSON.parse(localStorage.getItem(THEME_KEY) || '[]');
      }

      getCustomSurprises() {
        return JSON.parse(localStorage.getItem(SURPRISE_KEY) || '[]');
      }

      renderCustomWallpapers() {
        const grid = document.getElementById('customWallpapersGrid');
        grid.innerHTML = '';
        
        const customWallpapers = this.getCustomWallpapers();
        
        if (customWallpapers.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No custom wallpapers uploaded yet.</p>';
          return;
        }
        
        customWallpapers.forEach((wallpaper, index) => {
          const wallpaperItem = document.createElement('div');
          wallpaperItem.className = 'custom-item';
          wallpaperItem.innerHTML = `
            <img src="${wallpaper.url}" alt="${wallpaper.name}">
            <h4>${wallpaper.name}</h4>
            <div class="custom-item-actions">
              <button class="btn custom-item-btn apply-btn" data-index="${index}">Apply</button>
              <button class="btn custom-item-btn delete-btn" data-index="${index}">Delete</button>
            </div>
          `;
          
          wallpaperItem.querySelector('.apply-btn').addEventListener('click', () => {
            this.applyCustomWallpaper(wallpaper);
          });
          
          wallpaperItem.querySelector('.delete-btn').addEventListener('click', () => {
            this.deleteCustomWallpaper(index);
          });
          
          grid.appendChild(wallpaperItem);
        });
      }

      renderCustomThemes() {
        const grid = document.getElementById('customThemesGrid');
        grid.innerHTML = '';
        
        const customThemes = this.getCustomThemes();
        
        if (customThemes.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No custom themes uploaded yet.</p>';
          return;
        }
        
        customThemes.forEach((theme, index) => {
          const themeItem = document.createElement('div');
          themeItem.className = 'custom-item';
          themeItem.innerHTML = `
            <div style="width: 100%; height: 100px; background: var(--primary); border-radius: 6px; margin-bottom: 0.5rem;"></div>
            <h4>${theme.name}</h4>
            <div class="custom-item-actions">
              <button class="btn custom-item-btn apply-btn" data-index="${index}">Apply</button>
              <button class="btn custom-item-btn delete-btn" data-index="${index}">Delete</button>
            </div>
          `;
          
          themeItem.querySelector('.apply-btn').addEventListener('click', () => {
            this.applyCustomTheme(theme);
          });
          
          themeItem.querySelector('.delete-btn').addEventListener('click', () => {
            this.deleteCustomTheme(index);
          });
          
          grid.appendChild(themeItem);
        });
      }

      renderCustomSurprises() {
        const grid = document.getElementById('customSurprisesGrid');
        grid.innerHTML = '';
        
        const customSurprises = this.getCustomSurprises();
        
        if (customSurprises.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No custom surprises uploaded yet.</p>';
          return;
        }
        
        customSurprises.forEach((surprise, index) => {
          const surpriseItem = document.createElement('div');
          surpriseItem.className = 'custom-item';
          surpriseItem.innerHTML = `
            <div style="width: 100%; height: 100px; background: var(--accent); border-radius: 6px; margin-bottom: 0.5rem;"></div>
            <h4>${surprise.name}</h4>
            <div class="custom-item-actions">
              <button class="btn custom-item-btn apply-btn" data-index="${index}">Apply</button>
              <button class="btn custom-item-btn delete-btn" data-index="${index}">Delete</button>
            </div>
          `;
          
          surpriseItem.querySelector('.apply-btn').addEventListener('click', () => {
            this.applyCustomSurprise(surprise);
          });
          
          surpriseItem.querySelector('.delete-btn').addEventListener('click', () => {
            this.deleteCustomSurprise(index);
          });
          
          grid.appendChild(surpriseItem);
        });
      }

      deleteCustomWallpaper(index) {
        const wallpapers = this.getCustomWallpapers();
        if (index >= 0 && index < wallpapers.length) {
          wallpapers.splice(index, 1);
          localStorage.setItem(WALLPAPER_KEY, JSON.stringify(wallpapers));
          this.customWallpapers = wallpapers;
          this.renderCustomWallpapers();
          this.showNotification('Wallpaper deleted!', 'success');
        }
      }

      deleteCustomTheme(index) {
        const themes = this.getCustomThemes();
        if (index >= 0 && index < themes.length) {
          themes.splice(index, 1);
          localStorage.setItem(THEME_KEY, JSON.stringify(themes));
          this.customThemes = themes;
          this.renderCustomThemes();
          this.showNotification('Theme deleted!', 'success');
        }
      }

      deleteCustomSurprise(index) {
        const surprises = this.getCustomSurprises();
        if (index >= 0 && index < surprises.length) {
          surprises.splice(index, 1);
          localStorage.setItem(SURPRISE_KEY, JSON.stringify(surprises));
          this.customSurprises = surprises;
          this.renderCustomSurprises();
          this.showNotification('Surprise deleted!', 'success');
        }
      }

      // Library System
      setupLibrarySystem() {
        document.querySelectorAll('.library-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            
            // Update active tab
            document.querySelectorAll('.library-tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => {
              content.style.display = 'none';
            });
            document.getElementById(tabName + 'Content').style.display = 'block';
            
            // Load content if needed
            if (tabName === 'saved') {
              this.renderSavedContent();
            } else if (tabName === 'history') {
              this.renderHistoryContent();
            }
          });
        });
      }

      addToLibrary(file) {
        if (!this.isPremium) {
          this.showNotification('This feature is for Premium users only. Upgrade to save packs!', 'error');
          this.showPremiumModal();
          return;
        }

        const library = this.getLibrary();
        const existingIndex = library.findIndex(item => item.name === file.name);
        
        if (existingIndex === -1) {
          library.push({
            name: file.name,
            download_url: file.download_url,
            size: file.size,
            addedAt: new Date().toISOString()
          });
          
          localStorage.setItem(LIBRARY_KEY, JSON.stringify(library));
          this.library = library;
          
          this.showNotification('Added to library!', 'success');
        } else {
          this.showNotification('Already in library!', 'warning');
        }
      }

      removeFromLibrary(fileName) {
        const library = this.getLibrary();
        const updatedLibrary = library.filter(item => item.name !== fileName);
        localStorage.setItem(LIBRARY_KEY, JSON.stringify(updatedLibrary));
        this.library = updatedLibrary;
        
        this.showNotification('Removed from library!', 'success');
        this.renderSavedContent();
      }

      addToHistory(action, type = 'general') {
        const history = this.getHistory();
        history.unshift({
          action: action,
          type: type,
          timestamp: new Date().toISOString()
        });
        
        // Keep only last 100 items
        if (history.length > 100) {
          history.splice(100);
        }
        
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        this.history = history;
      }

      addToDownloadHistory(file) {
        const history = this.getDownloadHistory();
        history.unshift({
          name: file.name,
          size: file.size,
          timestamp: new Date().toISOString()
        });
        
        // Keep only last 50 downloads
        if (history.length > 50) {
          history.splice(50);
        }
        
        localStorage.setItem(DOWNLOAD_HISTORY_KEY, JSON.stringify(history));
        this.downloadHistory = history;
      }

      getLibrary() {
        return JSON.parse(localStorage.getItem(LIBRARY_KEY) || '[]');
      }

      getHistory() {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      }

      getDownloadHistory() {
        return JSON.parse(localStorage.getItem(DOWNLOAD_HISTORY_KEY) || '[]');
      }

      renderSavedContent() {
        const content = document.getElementById('savedContent');
        const library = this.getLibrary();
        
        if (library.length === 0) {
          content.innerHTML = '<div class="status-message">No saved packs yet.</div>';
          return;
        }
        
        content.innerHTML = library.map(item => `
          <div class="saved-item">
            <div>
              <h4>${item.name}</h4>
              <p>Size: ${(item.size / 1024 / 1024).toFixed(2)} MB</p>
              <p>Added: ${new Date(item.addedAt).toLocaleDateString()}</p>
            </div>
            <div>
              <button class="btn" onclick="fileManager.downloadFile(${JSON.stringify(item).replace(/"/g, '&quot;')})">Download</button>
              <button class="btn danger" onclick="premiumSystem.removeFromLibrary('${item.name}')">Remove</button>
            </div>
          </div>
        `).join('');
      }

      renderHistoryContent() {
        const content = document.getElementById('historyContent');
        const history = this.getHistory();
        
        if (history.length === 0) {
          content.innerHTML = '<div class="status-message">No history yet.</div>';
          return;
        }
        
        content.innerHTML = history.map(item => `
          <div class="history-item">
            <div>${item.action}</div>
            <div class="history-timestamp">${new Date(item.timestamp).toLocaleString()}</div>
          </div>
        `).join('');
      }

      loadSavedCustomizations() {
        // Load saved wallpaper
        const savedWallpaper = localStorage.getItem('selected_wallpaper');
        if (savedWallpaper) {
          document.body.classList.add('custom-bg');
          document.body.style.setProperty('--custom-bg-url', `url(${savedWallpaper})`);
        }
        
        // Load saved theme
        const savedTheme = localStorage.getItem('custom_theme');
        if (savedTheme) {
          try {
            const themeData = JSON.parse(savedTheme);
            this.applyCustomTheme(themeData);
          } catch (e) {
            console.error('Error loading saved theme:', e);
          }
        }
      }

      showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
          position: fixed;
          top: 100px;
          right: 20px;
          background: ${type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)'};
          color: white;
          padding: 1rem 1.5rem;
          border-radius: var(--border-radius);
          box-shadow: var(--shadow);
          z-index: 10001;
          max-width: 300px;
          word-wrap: break-word;
          animation: slideInRight 0.3s ease;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
        
        // Add CSS for animation
        if (!document.getElementById('notification-styles')) {
          const style = document.createElement('style');
          style.id = 'notification-styles';
          style.textContent = `
            @keyframes slideInRight {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(100%); opacity: 0; }
            }
          `;
          document.head.appendChild(style);
        }
      }
    }

    // File Manager
    class FileManager {
      constructor() {
        this.files = [];
        this.filteredFiles = [];
        this.currentCategoryFilter = 'All';
        this.currentTypeFilter = 'all';
        this.currentSortBy = 'az';
        this.currentTrendFilter = 'all';
        this.isLoading = false;
        
        this.init();
      }

      async init() {
        this.setupEventListeners();
        await this.loadFiles();
      }

      setupEventListeners() {
        // Search input
        document.getElementById('searchInput').addEventListener('input', () => {
          this.applyFiltersAndSearch();
        });

        // Dropdowns
        document.getElementById('fileTypeButton').addEventListener('click', (e) => {
          e.stopPropagation();
          premiumSystem.toggleDropdown(e.target.closest('.dropdown-button'), document.getElementById('fileTypeOptions'));
        });

        document.getElementById('sortByButton').addEventListener('click', (e) => {
          e.stopPropagation();
          premiumSystem.toggleDropdown(e.target.closest('.dropdown-button'), document.getElementById('sortByOptions'));
        });

        // Dropdown options
        document.getElementById('fileTypeOptions').addEventListener('click', (e) => {
          if (e.target.classList.contains('dropdown-option')) {
            premiumSystem.selectOption(e.target, document.getElementById('fileTypeButton'), document.getElementById('fileTypeOptions'));
            this.currentTypeFilter = e.target.getAttribute('data-value');
            this.applyFiltersAndSearch();
          }
        });

        document.getElementById('sortByOptions').addEventListener('click', (e) => {
          if (e.target.classList.contains('dropdown-option')) {
            premiumSystem.selectOption(e.target, document.getElementById('sortByButton'), document.getElementById('sortByOptions'));
            this.currentSortBy = e.target.getAttribute('data-value');
            this.applyFiltersAndSearch();
          }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
          premiumSystem.closeAllDropdowns();
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
          window.location.reload();
        });

        // Help button
        document.getElementById('helpBtn').addEventListener('click', () => {
          document.getElementById('helpModal').style.display = 'flex';
        });

        document.getElementById('helpClose').addEventListener('click', () => {
          document.getElementById('helpModal').style.display = 'none';
        });

        // Footer modals
        document.getElementById('aboutBtn').addEventListener('click', () => {
          this.showFooterModal('about');
        });

        document.getElementById('privacyBtn').addEventListener('click', () => {
          this.showFooterModal('privacy');
        });

        document.getElementById('contactBtn').addEventListener('click', () => {
          this.showFooterModal('contact');
        });

        document.getElementById('footerModalBack').addEventListener('click', () => {
          document.getElementById('footerModal').style.display = 'none';
          document.body.style.overflow = '';
        });

        // Download cancel button
        document.getElementById('downloadCancelBtn').addEventListener('click', () => {
          this.cancelDownload();
        });
      }

      async loadFiles() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const fileList = document.getElementById('fileList');
        
        loadingOverlay.style.display = 'flex';
        fileList.innerHTML = '';
        
        // Show skeleton loading
        this.showSkeletonLoading();
        
        try {
          // Check cache first
          const cached = this.getCachedFiles();
          if (cached) {
            this.files = cached;
            this.processFiles();
            loadingOverlay.style.display = 'none';
            document.getElementById('websiteSkeleton').style.display = 'none';
            return;
          }

          // Fetch from all 7 repositories
          const allFiles = [];
          
          for (const repo of REPOS) {
            try {
              const response = await fetch(`https://api.github.com/repos/${GH_USERNAME}/${repo}/contents/`);
              if (!response.ok) continue;
              
              const data = await response.json();
              const repoFiles = this.processRepoFiles(data, repo);
              allFiles.push(...repoFiles);
            } catch (error) {
              console.error(`Error loading repo ${repo}:`, error);
              continue;
            }
          }

          this.files = allFiles;
          this.cacheFiles(this.files);
          this.processFiles();
        } catch (error) {
          console.error('Error loading files:', error);
          fileList.innerHTML = '<div class="status-message status-error">Error loading packs. Please try refreshing.</div>';
        } finally {
          loadingOverlay.style.display = 'none';
          document.getElementById('websiteSkeleton').style.display = 'none';
        }
      }

      processRepoFiles(data, repo) {
        return data
          .filter(item => item.name.match(/\.(mcpack|mcworld)$/i))
          .map(item => {
            const baseName = item.name.replace(/\.(mcpack|mcworld)$/i, '');
            const fileType = item.name.match(/\.(mcpack|mcworld)$/i)[1].toLowerCase();
            
            return {
              name: item.name,
              baseName: baseName,
              download_url: item.download_url,
              size: item.size,
              type: fileType,
              repo: repo,
              thumbnail_url: this.getThumbnailUrl(baseName, repo),
              description_url: this.getDescriptionUrl(baseName, repo),
              category: this.extractCategory(baseName)
            };
          });
      }

      getThumbnailUrl(baseName, repo) {
        const formats = ['.jpg', '.png', '.jpeg', '.gif'];
        for (const format of formats) {
          return `https://raw.githubusercontent.com/${GH_USERNAME}/${repo}/main/${baseName}${format}`;
        }
        return '';
      }

      getDescriptionUrl(baseName, repo) {
        return `https://raw.githubusercontent.com/${GH_USERNAME}/${repo}/main/${baseName}.txt`;
      }

      extractCategory(baseName) {
        // Simple category extraction - you can enhance this
        const categories = ['All', 'Texture', 'Survival', 'Adventure', 'MiniGame', 'Map', 'Skin', 'Addon'];
        
        for (const category of categories) {
          if (baseName.toLowerCase().includes(category.toLowerCase())) {
            return category;
          }
        }
        
        return 'Other';
      }

      processFiles() {
        this.renderCategories();
        this.applyFiltersAndSearch();
      }

      renderCategories() {
        const carousel = document.getElementById('categoriesCarousel');
        const categories = ['All', ...new Set(this.files.map(file => file.category))];
        
        carousel.innerHTML = categories.map(category => `
          <button class="category-chip ${category === 'All' ? 'active' : ''}" data-category="${category}">
            ${category}
          </button>
        `).join('');
        
        // Add event listeners
        carousel.querySelectorAll('.category-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            carousel.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            this.currentCategoryFilter = chip.getAttribute('data-category');
            this.applyFiltersAndSearch();
          });
        });
      }

      applyFiltersAndSearch() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = this.files.filter(file => {
          // Category filter
          if (this.currentCategoryFilter !== 'All' && file.category !== this.currentCategoryFilter) {
            return false;
          }
          
          // Type filter
          if (this.currentTypeFilter !== 'all' && file.type !== this.currentTypeFilter) {
            return false;
          }
          
          // Search filter
          if (searchTerm && !file.name.toLowerCase().includes(searchTerm) && 
              !file.baseName.toLowerCase().includes(searchTerm)) {
            return false;
          }
          
          return true;
        });
        
        // Sort
        filtered = this.sortFiles(filtered, this.currentSortBy);
        
        this.filteredFiles = filtered;
        this.renderFiles();
      }

      sortFiles(files, sortBy) {
        const sorted = [...files];
        
        switch (sortBy) {
          case 'az':
            return sorted.sort((a, b) => a.name.localeCompare(b.name));
          case 'za':
            return sorted.sort((a, b) => b.name.localeCompare(a.name));
          case 'largest':
            return sorted.sort((a, b) => (b.size || 0) - (a.size || 0));
          case 'smallest':
            return sorted.sort((a, b) => (a.size || 0) - (b.size || 0));
          default:
            return sorted;
        }
      }

      renderFiles() {
        const fileList = document.getElementById('fileList');
        
        if (this.filteredFiles.length === 0) {
          fileList.innerHTML = '<div class="status-message">No packs found matching your criteria.</div>';
          return;
        }
        
        fileList.innerHTML = this.filteredFiles.map(file => `
          <div class="file" role="listitem">
            <img class="thumbnail" src="${file.thumbnail_url}" alt="${file.baseName}" 
                 onerror="this.src='https://raw.githubusercontent.com/sifat8668/M-packs/main/got.png'">
            <div class="name">${file.baseName}</div>
            <div class="meta">
              <span>${(file.size / 1024 / 1024).toFixed(2)} MB</span>
              <span>${file.type}</span>
              <span>${file.repo}</span>
            </div>
            <div class="actions">
              <button class="btn" onclick="fileManager.downloadFile(${JSON.stringify(file).replace(/"/g, '&quot;')})">
                ⬇️ Download
              </button>
              <button class="btn secondary" onclick="fileManager.showFileDetails(${JSON.stringify(file).replace(/"/g, '&quot;')})">
                ℹ️ Details
              </button>
              <button class="btn save" onclick="premiumSystem.addToLibrary(${JSON.stringify(file).replace(/"/g, '&quot;')})">
                💾 Save
              </button>
            </div>
          </div>
        `).join('');
      }

      showSkeletonLoading() {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = `
          <div class="file">
            <div class="skeleton skeleton-thumbnail"></div>
            <div class="skeleton skeleton-name"></div>
            <div class="skeleton skeleton-meta"></div>
            <div class="skeleton skeleton-actions"></div>
          </div>
          <div class="file">
            <div class="skeleton skeleton-thumbnail"></div>
            <div class="skeleton skeleton-name"></div>
            <div class="skeleton skeleton-meta"></div>
            <div class="skeleton skeleton-actions"></div>
          </div>
          <div class="file">
            <div class="skeleton skeleton-thumbnail"></div>
            <div class="skeleton skeleton-name"></div>
            <div class="skeleton skeleton-meta"></div>
            <div class="skeleton skeleton-actions"></div>
          </div>
        `;
      }

      async downloadFile(file) {
        const downloadingScreen = document.getElementById('downloadingScreen');
        const fileName = document.getElementById('downloadFileName');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        // Record download
        premiumSystem.addToDownloadHistory(file);
        premiumSystem.addToHistory(`Downloaded: ${file.name}`, 'download');
        
        fileName.textContent = file.name;
        downloadingScreen.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        try {
          // Show initial progress
          progressBar.style.width = '0%';
          progressBar.setAttribute('aria-valuenow', 0);
          progressText.textContent = 'Starting download...';
          
          // Simulate download progress
          for (let i = 0; i <= 100; i++) {
            if (this.downloadCancelled) break;
            
            progressBar.style.width = i + '%';
            progressBar.setAttribute('aria-valuenow', i);
            progressText.textContent = `Downloading... ${i}%`;
            
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 50));
          }
          
          if (!this.downloadCancelled) {
            progressText.textContent = 'Download complete!\nFile saved with correct extension.';
            
            // Create and trigger download
            const a = document.createElement('a');
            a.href = file.download_url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Close after delay
            setTimeout(() => {
              downloadingScreen.style.display = 'none';
              document.body.style.overflow = '';
              this.downloadCancelled = false;
            }, 2000);
          }
        } catch (error) {
          console.error('Download error:', error);
          progressText.textContent = 'Download failed. Please try again.';
        }
      }

      cancelDownload() {
        this.downloadCancelled = true;
        document.getElementById('downloadingScreen').style.display = 'none';
        document.body.style.overflow = '';
        
        premiumSystem.showNotification('Download cancelled', 'warning');
      }

      async showFileDetails(file) {
        const modal = document.getElementById('fileDetailsModal');
        const title = document.getElementById('fileDetailsTitle');
        const thumbnail = document.getElementById('fileDetailsThumbnail');
        const description = document.getElementById('fileDetailsDescription');
        const links = document.getElementById('fileDetailsLinks');
        
        title.textContent = file.baseName;
        thumbnail.src = file.thumbnail_url;
        thumbnail.alt = file.baseName;
        
        // Set fallback for thumbnail
        thumbnail.onerror = function() {
          this.src = 'https://raw.githubusercontent.com/sifat8668/M-packs/main/got.png';
        };
        
        // Load description
        try {
          const response = await fetch(file.description_url);
          if (response.ok) {
            const text = await response.text();
            description.textContent = text || 'No description available.';
          } else {
            description.textContent = 'No description available.';
          }
        } catch (error) {
          description.textContent = 'No description available.';
        }
        
        // Create links
        links.innerHTML = `
          <a href="${file.download_url}" class="file-details-link" download="${file.name}">
            <span class="file-details-link-icon">⬇️</span>
            Download
          </a>
          <button class="file-details-link" onclick="premiumSystem.addToLibrary(${JSON.stringify(file).replace(/"/g, '&quot;')})">
            <span class="file-details-link-icon">💾</span>
            Save to Library
          </button>
        `;
        
        modal.style.display = 'flex';
      }

      showFooterModal(section) {
        const modal = document.getElementById('footerModal');
        const content = document.getElementById('footerModalContent');
        
        // Open the accordion for the selected section
        const accordionHeader = document.querySelector(`[data-accordion="${section}"]`);
        if (accordionHeader) {
          accordionHeader.click();
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      getCachedFiles() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        
        try {
          const data = JSON.parse(cached);
          if (Date.now() - data.timestamp < CACHE_TIMEOUT) {
            return data.files;
          }
        } catch (e) {
          console.error('Error parsing cache:', e);
        }
        
        return null;
      }

      cacheFiles(files) {
        const data = {
          files: files,
          timestamp: Date.now()
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      }
    }

    // Initialize the application
    const premiumSystem = new PremiumSystem();
    const fileManager = new FileManager();

    // Make available globally
    window.premiumSystem = premiumSystem;
    window.fileManager = fileManager;

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      premiumSystem.closeAllDropdowns();
    });

    // Prevent dropdown clicks from closing dropdowns
    document.querySelectorAll('.dropdown-options').forEach(options => {
      options.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    // Help modal close on outside click
    window.addEventListener('click', (e) => {
      const helpModal = document.getElementById('helpModal');
      if (e.target === helpModal) {
        helpModal.style.display = 'none';
      }
    });

    // Premium modal close on outside click
    window.addEventListener('click', (e) => {
      const premiumModal = document.getElementById('premiumModal');
      if (e.target === premiumModal) {
        premiumSystem.hidePremiumModal();
      }
    });

    console.log('Minecraft File Manager Premium initialized successfully!');
  })();
  </script>
</body>
</html>